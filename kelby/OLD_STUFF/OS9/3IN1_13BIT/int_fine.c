#include <stdio.h>#include <math.h>#include <time.h>struct sgtbuf timebuf;int sw1,sw2,sw3,sw4,sw5,sw6,sw7,sw8;int fdata[3][256],ipk[3],pk[3];struct{unsigned int trig;       unsigned int reset;       unsigned int status;       unsigned int sample;       unsigned int delay;       unsigned int rdall;       unsigned int rd2;       unsigned int rd1;       unsigned int rd0;}fermi;unsigned short *reg;unsigned short *reg0,*reg1,*reg2;unsigned int base=0xf0ee0000;unsigned int base2=0x80ee0000;/*double crg[6500],fvl[6500]; */unsigned int delay;int card,zone,sector;int year,month,day,hour,min,sec;char xstring[80],ystring[80],string[80],err[80];unsigned char gpib_adr = 4;double nl[6] = {3.0,3.0,5.0,8.0,10.0,10.0};double nll[6] = {3.0,5.0,5.0,8.0,12.0,20.0};double sl[6] = {11.7,108.0,117.0,230.0,320.0,430.0};double sh[6] = {14.3,132.0,143.0,280.0,390.0,510.0};double crg[100],vlt[100];int dc[100];int ent=0,FAIL,kFAIL;FILE *fp;main(argc,argv,envs)int argc;char *argv[];char *envs[];{  double t0,tnow,dt;   int cardnumber,ii;    printf("input 3in1 card number\n");    fscanf(stdin,"%d",&cardnumber);    sprintf(string,"/h0/kja/3in1_13bit/C%d.pre",cardnumber);    printf("%s\n",string);    fp = fopen(string,"w");    fprintf(fp,"serial number: %d     Bed: 7  Position: 47\n",cardnumber);    newtime();    year = year + 1900;    fprintf(fp," date tested: %2d/%2d/%4d      Test Number: 4\n\n",month,day,year);    multi_low();    card = 38;    zone = 1;    sector = 1;    FAIL=0;    chk_int();    printf("c%d.pre\n",cardnumber);    ii=fclose(fp);    sprintf(string,"list /h0/kja/3in1_13bit/C%d.pre",cardnumber);    system(string);    if(FAIL==0)     { printf(" CARD PASSED\n");       fprintf(fp,"CARD PASSED\n");     }    if(FAIL!=0)     { printf(" CARD FAILED\n");       fprintf(fp,"CARD FAILED\n");     }    printf("c%d.pre\n",cardnumber);}chk_int() { int isw[6],i1,i2,ll,i,mode,s1,s2,s3,s4,sw8,itr,ire,mse,tpe,lcal;   int sw1,dacset,max[6],del[6],imax;   short cadr,sval,dval,tval,t1val,t2val;   double fmin,ratio,volt,ped,expr[6];   int l,gain,icnt,sbad,kja,ikja;   double s,sx,sy,sxy,sx2,delta,a,b,y,noise,sqr,slope;   double charge,dymax,dely,factor,dymaxf;   double p1,p2,p3,d1,d2,d3;   factor = 1000.0;   card = 47;   i = (zone<<12) | (sector<<6) | card;   cadr = (unsigned short)i;   multi_low();   card_sel(cadr);   tval = (short)100;   tim1_set(tval);   tval = (short)50;   tim2_set(tval);   rtime();   max[0]=800;   max[1]=200;   max[2]=180;   max[3]=100;   max[4]=60;   max[5]=50;   del[0]=20;   del[1]=5;   del[2]=3;   del[3]=2;   del[4]=1;   del[5]=1;   expr[0]=1.0;   expr[1]=2.7;   expr[2]=3.7;   expr[3]=7.2;   expr[4]=9.7;   expr[5]=13.2;   isw[0]=0xe;   isw[1]=0xd;   isw[2]=0xf;   isw[3]=0xb;   isw[4]=0x7;   isw[5]=0x3;      for(gain=5;gain>-1;gain--)    { dxyzro();      if(gain==0) dxyset(0,(double)max[gain],0.0,5.0,0.0,0,0);      if(gain!=0) dxyset(0,(double)max[gain],0.0,10.0,0.0,0,0);      sprintf(xstring,"isw=%x xaxis=dac value",isw[gain]);      sprintf(ystring,"yaxis=volts");      dxylbl(0,xstring,ystring);      if(gain==0) dxyset(1,(double)max[gain],0.0,0.01,-0.01,0,0);      if(gain!=0) dxyset(1,(double)max[gain],0.0,0.01,-0.01,0,0);      sprintf(xstring,"isw=%x xaxis=dac value",isw[gain]);      sprintf(ystring,"yaxis=y-yfit");      dxylbl(1,xstring,ystring);      if(gain==0) dxyset(2,(double)max[gain],0.0,0.1,-0.1,0,0);      if(gain!=0) dxyset(2,(double)max[gain],0.0,0.1,-0.1,0,0);      sprintf(xstring,"isw=%x xaxis=dac value",isw[gain]);      sprintf(ystring,"yaxis=y-yfit");      dxylbl(2,xstring,ystring);      send13_3in1(2,isw[gain]);      send4_3in1(0,0);  /* intg_rd=0 */      send4_3in1(1,0);  /* itr=0 */      s = 0.0;      sx = 0.0;      sx2 = 0.0;      for(kja=0;kja<5;kja++)        { send13_3in1(6,0);          tsleep(0x80000010);          go_get(&ped);        }      for(i=0;i<5;i++)       { tsleep(0x80000010);         go_get(&p1);         tsleep(0x80000010);         go_get(&p2);         tsleep(0x80000010);         go_get(&p3);         d1 = fabs(p1-p2);         d2 = fabs(p2-p3);         d3 = fabs(p1-p3);         ikja=1;         if(d1<d1 && d1<d3) ikja=1;         if(d2<d1 && d2<d3) ikja=2;         if(d3<d1 && d3<d2) ikja=3;         if(ikja == 1) ped = 0.5*(p1+p2);         if(ikja == 2) ped = 0.5*(p2+p3);         if(ikja == 3) ped = 0.5*(p1+p3);         s = s + 1.0;         sx = sx + ped;         sx2 = sx2 + ped*ped;       }      ped = sx/s;      sqr = sx2/s - ped*ped;      noise = 0.0;      if(sqr>0.0) noise = sqrt(sqr)*factor;      printf("gain setting %d  ped=%f\n",gain,ped);      dacset = max[gain];      icnt = 0;      s = 0.0;      sx = 0.0;      sy = 0.0;      sxy = 0.0;      sx2 = 0.0;      for(i=0;i<dacset;i=i+del[gain])              { sw1 = sw(1);         send13_3in1(6,i);         tsleep(0x80000010);         go_get(&p1);         tsleep(0x80000010);         go_get(&p2);         tsleep(0x80000010);         go_get(&p3);         d1 = fabs(p1-p2);         d2 = fabs(p2-p3);         d3 = fabs(p1-p3);         ikja=1;         if(d1<d1 && d1<d3) ikja=1;         if(d2<d1 && d2<d3) ikja=2;         if(d3<d1 && d3<d2) ikja=3;         if(ikja == 1) volt = 0.5*(p1+p2);         if(ikja == 2) volt = 0.5*(p2+p3);         if(ikja == 3) volt = 0.5*(p1+p3);         fmin=volt-ped;         if(sw1 == 0) printf("dac=%d  volt=%f  ped=%f\n",i,volt,ped);         dxyacc(0,(double)i,fmin,0.0,0);         charge = 4.0 * 100.0 * (double)i / 1023.0;         s = s +1.0;         sx = sx + charge;         sy = sy + volt;         sxy = sxy + charge*volt;         sx2 = sx2 + charge*charge;         crg[icnt] = charge;         vlt[icnt] = volt;         dc[icnt] = i;          icnt++;       }       dxywrt(0);       delta = s*sx2 - sx*sx;       a = (sx2*sy - sx*sxy) / delta;       b = (s*sxy - sx*sy) / delta;       printf(" integrator gain=%d fit results a=%f b=%f y=a+b*charge\n",               gain,a,b);       dymax = 0.0;       imax = -1;       for(i=0;i<icnt;i++)        { y = a + b * crg[i];          dely = y - vlt[i];          dxyacc(1,(double)dc[i],dely,0.0,0);          dxyacc(2,(double)dc[i],dely,0.0,0);          if(dely>dymax)             { dymax = dely;              imax = i;            }         printf("  i=%d  vlt=%f  y=%f  dely=%f\n",               i,vlt[i],y,dely);        }       dxywrt(1);       dxywrt(2);       dymaxf = factor * dymax;       slope = factor * b;       kFAIL=0;        if(noise>nl[gain]) kFAIL=1;       if(dymaxf>nll[gain]) kFAIL=2;       if(slope<sl[gain]) kFAIL=3;       if(slope>sh[gain]) kFAIL=4;       printf("%d ----- integrator nonlin=%f %f %d  --------------- FAIL=%d\n",          gain,dymaxf,dymax,imax,kFAIL);       if(kFAIL != 0) FAIL = kFAIL;       if(kFAIL == 0) fprintf(fp,"Gain %d  noise=%6.2f  slope=%6.2f   nonlin=%6.2f   OK\n",           gain,noise,slope,dymaxf);       if(kFAIL != 0) fprintf(fp,"Gain %d  noise=%6.2f  slope=%6.2f   nonlin=%6.2f  BAD\n",           gain,noise,slope,dymaxf);    }   sbad = 0;   send13_3in1(6,48);   send4_3in1(0,0);  /* intg_rd=0 */   send4_3in1(1,0);  /* itr=0 */   tsleep(0x80000100);   go_get(&volt);   printf("intg_rd=0 itr=0 on volt=%f\n",volt);   if(volt < 8.5) sbad = 1;   send4_3in1(0,0);  /* intg_rd=0 */   send4_3in1(1,1);  /* itr=1 */   tsleep(0x80000100);   go_get(&volt);   printf("intg_rd=0 itr=1 on volt=%f\n",volt);   if(volt > 2.0) sbad = 1;      send4_3in1(0,1);  /* intg_rd=1 */   send4_3in1(1,0);  /* itr=0 */   tsleep(0x80000100);   go_get(&volt);   printf("intg_rd=1 itr=0 on volt=%f\n",volt);   if(volt > 2.0) sbad = 1;   send4_3in1(0,0);  /* intg_rd=0 */   send4_3in1(1,0);  /* itr=0 */   tsleep(0x80000100);   go_get(&volt);   printf("intg_rd=0 itr=0 on volt=%f\n",volt);   if(volt < 8.5) sbad = 1;   if(sbad == 0) fprintf(fp," Gate Open/Close : Good\n");   if(sbad != 0) fprintf(fp," Gate Open/Close : Bad\n");   printf("card=%d\n",card);   printf("\n\n\n");}/* old switch modulesw(i)  int i;  {int *adr,k,l,shft;   adr=(int *)0x80cf0000;   k=*adr;   shft=23+i;   l=(k>>shft)&1;    return(l);  }      */    go_get(v)      double *v;      {double volts;       if(ent == 0)         {gpib_reset();          sendmessage(gpib_adr,"A2 X");          tsleep(0x80000005);/*          sendmessage(gpib_adr,"A? X");          getmessage(gpib_adr, &string[0] );          printf("A2 back=%s\n",string); */          sendmessage(gpib_adr,"C X");          tsleep(0x80000005);/*          sendmessage(gpib_adr,"C? X");          getmessage(gpib_adr, &string[0] );          printf("C back=%s\n",string); */            sendmessage(gpib_adr,"R3 X");          tsleep(0x80000005);/*          sendmessage(gpib_adr,"R? X");          getmessage(gpib_adr, &string[0] );          printf("R1,3 back=%s\n",string); */          sendmessage(gpib_adr,"N1 X");          tsleep(0x80000005);/*          sendmessage(gpib_adr,"N? X");          getmessage(gpib_adr, &string[0] );          printf("N1 back=%s\n",string); */          sendmessage(gpib_adr,"G0 X");          tsleep(0x80000005);/*          sendmessage(gpib_adr,"G? X");          getmessage(gpib_adr, &string[0] );          printf("G0 back=%s\n",string); */            sendmessage(gpib_adr,"Q0 X");          tsleep(0x80000005);/*          sendmessage(gpib_adr,"Q? X");          getmessage(gpib_adr, &string[0] );          printf("Q0 back=%s\n",string); */          ent=1;         }          sendmessage(gpib_adr,"T6 X");/*          sendmessage(gpib_adr,"T? X");          getmessage(gpib_adr, &string[0] );          printf("T6 back=%s\n",string); */          tsleep(0x80000020);          getmessage(gpib_adr, &string[0] );/*          printf("first readback=%s\n",string); */          sscanf(string,"%le",&volts);/*          printf("volts=%e\n",volts);  */          *v=volts*0.95;          return(0);}      double dxyfit(l,k,x)      int l,k;      double x;      { double dxyf;        dxyf=0.0;  /* dummy routine */        return(dxyf);      }sw(i)   /* new switch timer module */int i;{ int k,l,shift;  unsigned short *adr;  adr = (unsigned short *)( 0xf0aa000c);  k = *adr;  shift = i-1;  l = (k>>shift) & 1;  return(l);}fermi_setup() { FPermit(base,0x100,3);   FPermit(base2,0x100,3);   fermi.trig=base+0x26;   fermi.reset=base+0x24;   fermi.status=base+0x22;   fermi.sample=base+0x20;   fermi.delay=base+0x1e;   fermi.rdall=base2+0x18;   fermi.rd2=base+0x14;   fermi.rd1=base+0x12;   fermi.rd0=base+0x10;/* issue reset */   reg=(unsigned short *)fermi.reset;   *reg=0;/* set to full 255 samples */   reg=(unsigned short *)fermi.sample;   *reg=255;/* set delay */   reg=(unsigned short *)fermi.delay;   *reg=2;   reg0=(unsigned short *) fermi.rd0;   reg1=(unsigned short *) fermi.rd1;   reg2=(unsigned short *) fermi.rd2; }fermi_reset() { /* issue reset */   reg=(unsigned short *)fermi.reset;   *reg=0; }fermi_read() { int stat,data_ready,busy,lcnt,i,k0,k1,k2,kmax0,kmax1,kmax2;   int dd0,dd1,dd2;   unsigned short sd0,sd1,sd2;   /* wait for a trigger */loop:   lcnt=0;   lcnt++;   reg = (unsigned short *)fermi.status;   stat = *reg;   data_ready = stat & 4;   busy = stat & 2;   if(lcnt > 1000 ) goto error;   if ( data_ready == 0 ) goto loop;   /* read the data and find peak channel */   k0=0;   kmax0=0;   k1=0;   kmax1=0;   k2=0;   kmax2=0;   for (i=0;i<255;i++)    { sd0 = *reg0;      dd0 = (int)sd0 & 0xfff;      fdata[0][i] = 0xfff - dd0;      if(fdata[0][i]>kmax0)       { kmax0=fdata[0][i];         k0=i;}      sd1 = *reg1;      dd1 = (int)sd1 & 0xfff;      fdata[1][i] = 0xfff - dd1;      if(fdata[1][i]>kmax1)       { kmax1=fdata[1][i];         k1=i;}      sd2 = *reg2;      dd2 = (int)sd2 & 0xfff;      fdata[2][i] = 0xfff - dd2;      if(fdata[2][i]>kmax2)       { kmax2=fdata[2][i];         k2=i;}      sw4 = sw(4);      if(sw4 == 1) printf("i=%d  dd0=%d  dd1=%d  dd2=$d\n",i,dd0,dd1,dd2);     }   ipk[0]=k0;   pk[0]=kmax0;   ipk[1]=k1;   pk[1]=kmax1;   ipk[2]=k2;   pk[2]=kmax2;   return(0);error:   ipk[0]=-1;   ipk[1]=-1;   ipk[2]=-1;}newtime() {  getime(&timebuf);    year = (int)timebuf.t_year;    month = (int)timebuf.t_month;    day = (int)timebuf.t_day;    hour = (int)timebuf.t_hour;    min = (int)timebuf.t_minute;    sec = (int)timebuf.t_second;/*    printf("newtime  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",          year,month,day,hour,min,sec);  */ }
#include <stdio.h>#include <math.h>#include <time.h>int year,month,day,hour,min,sec;struct sgtbuf timebuf;main(argc,argv,envs)int argc;char *argv[];char *envs[];{  FILE *fp;   int card,zone,sector,l,wait,i,ok,count,error;   unsigned short cadr,sval,dval;   int s1,s2,s3,s4,itr,ire,mse,tpS,tpL,trg;   double t0,tnow,dt;   char string[80];    printf("input 3in1 card serial number\n");    fscanf(stdin,"%d",&i);    sprintf(string,"card%d.log",i);    fp = fopen(string,"w");    fprintf(fp," testing 3in1 card serial number %d\n",i);    count=0;    error=0;    multi_low();    zone = 1;    sector = 1;    card = 1;    newtime();    tepoc(year,month,day,hour,min,sec,&t0);    printf("start time  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",          year,month,day,hour,min,sec);      fprintf(fp,"start time  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",          year,month,day,hour,min,sec);  start:       ok=0;       l = (zone<<12) | (sector<<6) | card;       cadr = (unsigned short)l;       card_sel(cadr);       send13_3in1(2,5);  /* s1=s3=1 s2=s4=0 */       send4_3in1(1,1);   /* itr=1 */       send4_3in1(0,0);   /* ire=0 */       send4_3in1(3,1);   /* mse=1 */       send4_3in1(4,0);   /* tpS=0 */       send4_3in1(5,1);   /* tpL=1 */       send4_3in1(7,0);   /* trig=0 */       sleep(1);       read_status(&sval);   /* read back the controller shift register */       i = (int)sval;       trg = (i>>3) & 1;       s1 = (i>>4) & 1;       s2 = (i>>5) & 1;       s3 = (i>>6) & 1;       s4 = (i>>7) & 1;       itr = (i>>8) & 1;       ire = (i>>9) & 1;       mse = (i>>10) & 1;       tpS = (i>>11) & 1;       tpL = (i>>12) & 1;       if( (s1==1) && (s2==0) && (s3==1) && (s4==0) && (itr==1) && (ire==0)         && (mse==1) && (tpS==0) && (tpL==1) && (trg==0) )ok++;       if(sw(2)==1)         { newtime();          tepoc(year,month,day,hour,min,sec,&tnow);          dt = tnow-t0;          printf("dt=%f  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",              dt,year,month,day,hour,min,sec);            printf("s1..4=1 0 1 0 itr=1 ire=0 mse=1 tpS=0 tpL=1 trg=0 sent\n");          printf("s1..4=%d %d %d %d itr=%d ire=%d mse=%d tpS=%d tpL=%d trg=%d %x\n"           ,s1,s2,s3,s4,itr,ire,mse,tpS,tpL,trg,i);        }       if(ok!=1)         { newtime();          tepoc(year,month,day,hour,min,sec,&tnow);          dt = tnow-t0;          printf("dt=%f  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",              dt,year,month,day,hour,min,sec);            printf("s1..4=1 0 1 0 itr=1 ire=0 mse=1 tpS=0 tpL=1 trg=0 sent\n");          printf("s1..4=%d %d %d %d itr=%d ire=%d mse=%d tpS=%d tpL=%d trg=%d %x\n"           ,s1,s2,s3,s4,itr,ire,mse,tpS,tpL,trg,i);          fprintf(fp,"dt=%f  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",              dt,year,month,day,hour,min,sec);            fprintf(fp,"s1..4=1 0 1 0 itr=1 ire=0 mse=1 tpS=0 tpL=1 trg=0 sent\n");          fprintf(fp,"s1..4=%d %d %d %d itr=%d ire=%d mse=%d tpS=%d tpL=%d trg=%d %x\n"           ,s1,s2,s3,s4,itr,ire,mse,tpS,tpL,trg,i);        }       send13_3in1(2,0xa);  /* s1=s3=0 s2=s4=1 */       send4_3in1(1,0);   /* itr=0 */       send4_3in1(0,1);   /* ire=1 */       send4_3in1(3,0);   /* mse=0 */       send4_3in1(4,1);   /* tpS=1 */       send4_3in1(5,0);   /* tpL=0 */       send4_3in1(7,1);   /* trig=1 */       sleep(1);       read_status(&sval);   /* read back the controller shift register */       i = (int)sval;       trg = (i>>3) & 1;       s1 = (i>>4) & 1;       s2 = (i>>5) & 1;       s3 = (i>>6) & 1;       s4 = (i>>7) & 1;       itr = (i>>8) & 1;       ire = (i>>9) & 1;       mse = (i>>10) & 1;       tpS = (i>>11) & 1;       tpL = (i>>12) & 1;       if( (s1==0) && (s2==1) && (s3==0) && (s4==1) && (itr==0) && (ire==1)         && (mse==0) && (tpS==1) && (tpL==0) && (trg==1) )ok++;       if(sw(2))         { newtime();          tepoc(year,month,day,hour,min,sec,&tnow);          dt = tnow-t0;          printf("dt=%f  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",             dt,year,month,day,hour,min,sec);            printf("s1..4=0 1 0 1 itr=0 ire=1 mse=0 tpS=1 tpL=0 trg=1 sent\n");          printf("s1..4=%d %d %d %d itr=%d ire=%d mse=%d tpS=%d tpL=%d trg=%d %x\n"           ,s1,s2,s3,s4,itr,ire,mse,tpS,tpL,trg,i);        }       if(ok!=2)         { newtime();          tepoc(year,month,day,hour,min,sec,&tnow);          dt = tnow-t0;          printf("dt=%f  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",             dt,year,month,day,hour,min,sec);            printf("s1..4=0 1 0 1 itr=0 ire=1 mse=0 tpS=1 tpL=0 trg=1 sent\n");          printf("s1..4=%d %d %d %d itr=%d ire=%d mse=%d tpS=%d tpL=%d trg=%d %x\n"           ,s1,s2,s3,s4,itr,ire,mse,tpS,tpL,trg,i);          fprintf(fp,"dt=%f  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",             dt,year,month,day,hour,min,sec);            fprintf(fp,"s1..4=0 1 0 1 itr=0 ire=1 mse=0 tpS=1 tpL=0 trg=1 sent\n");          fprintf(fp,"s1..4=%d %d %d %d itr=%d ire=%d mse=%d tpS=%d tpL=%d trg=%d %x\n"           ,s1,s2,s3,s4,itr,ire,mse,tpS,tpL,trg,i);        }  if(ok != 2) error++;  count++;  printf("count %d   error %d",count,error);  fflush(stdout);  printf("\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b");  if(sw(1) == 0) goto start;  newtime();  tepoc(year,month,day,hour,min,sec,&tnow);  dt = tnow-t0;  printf("ending dt=%f  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",              dt,year,month,day,hour,min,sec);    printf("ending count=%d   error=%d\n",count,error);  fprintf(fp,"end dt=%f  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",              dt,year,month,day,hour,min,sec);    fprintf(fp,"ending count=%d   error=%d\n",count,error);  i=fclose(fp); }sw(i)   /* new switch timer module */int i;{ int k,l,shift;  unsigned short *adr;  adr = (unsigned short *)( 0xf0aa000c);  k = *adr;  shift = i-1;  l = (k>>shift) & 1;  return(l);}newtime() {  getime(&timebuf);    year = (int)timebuf.t_year;    year=2001;    month = (int)timebuf.t_month;    day = (int)timebuf.t_day;    hour = (int)timebuf.t_hour;    min = (int)timebuf.t_minute;    sec = (int)timebuf.t_second;    if(sw(3)==1) printf("newtime  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",          year,month,day,hour,min,sec);   }tepoc(y,mo,d,h,min,s,days)double * days;int y,mo,d,h,min,s; { int leap,iy;   double day;/*                 0,31,28,31, 30, 31, 30, 31, 31, 30, 31, 30, 31 */   static int dmon[13] = {0,31,59,90,120,151,181,212,243,273,304,334,365};   static double ylast=0,ydays,modays,ddays,hdays,midays,sdays;    if(y != ylast)     {       ydays = 0.0;      for(iy=1900;iy<y;iy++)       { leap=0;         if(iy%4 == 0) leap=1;         if(iy%100 == 0) leap=0;         if(iy%400 == 0) leap=1;         ydays = ydays + 365.0 + (double)leap;/*         printf(" iy=%d  leap=%d  ydays=%f\n",iy,leap,ydays);  */       }      ylast = y;   }   modays = (double)dmon[mo];   ddays = (double)d - 1.0;   hdays = (double)h / 24.0;   midays = (double)min / 1440.0;   sdays = (double)s / 86400.0;   day = ydays + modays + ddays + hdays + midays + sdays;/*   printf("\n\n y=%d  mo=%d  d=%d  h=%d  min=%d  s=%d  days=%f\n",          y,mo,d,h,min,s,day);   printf("ydays=%f  modays=%f  ddays=%f\n  hdays=%f  midays=%f  sdays=%f\n",          ydays,modays,ddays,hdays,midays,sdays);   */   *days = day;  }
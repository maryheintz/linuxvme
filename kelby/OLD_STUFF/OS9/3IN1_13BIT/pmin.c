#include <stdio.h>#include <math.h>#include <time.h>main(argc,argv,envs)int argc;char *argv[];char *envs[];  { FILE *fp;    int zone,sector,card,time1,time2,time3,time4,i,icap;    int dac;    double capacitor,dacval;    double charge,charge_true;    unsigned short cadr,tc,tf;    unsigned short sval,dval;    zone = 1;   /* zone dialed in rotary hex switch on motherboard 1 */    sector = 1; /* sector dialed in rotary hex switches (2) on motherboard 1 */    time1 = 0;    time2 = 0;    time3 = 0;    time4 = 0;    set_drawer_timer(zone,sector,1,time1);  /* set TP delay on MB1 */    set_drawer_timer(zone,sector,2,time2);  /* set TP delay on MB2 */    set_drawer_timer(zone,sector,3,time3);  /* set TP delay on MB3 */    set_drawer_timer(zone,sector,4,time4);  /* set TP delay on MB4 */     /* caution set_drawer_timer changes the card address */    rxw_low();    multi_low();    card= 46;    i = (zone<<12) | (sector<<6) | card;    cadr = (unsigned short)i;    card_sel(cadr);  /* select the card to be addressed */    send13_3in1(2,0);   /* s1=s2=s3=s4=0 */    send4_3in1(1,0);   /* itr=0 */    send4_3in1(0,0);   /* ire=0 */    send4_3in1(3,0);   /* mse=0 */    send4_3in1(4,0);   /* small C disable */    send4_3in1(5,1);   /* large C enable */    send4_3in1(7,1);   /* trig enable */    tc = (unsigned short)25;    tim1_set(tc);   /* coarse time delay of charge injection */    tf = 0;    tim2_set(tf);   /* fine time delay of charge injection */    printf("which capacitor 1=large  2=small\n");    fscanf(stdin,"%d",&icap);    if(icap == 2)     { send4_3in1(4,1);   /* enable small capacitor */       send4_3in1(5,0);   /* disable large capacitor */       capacitor = 5.2;       charge = 30.0;     }    if(icap == 1)     { send4_3in1(4,0);   /* disable small capacitor */       send4_3in1(5,1);   /* enable large capacitor */       capacitor = 100.0;       charge=800.0;     }    printf(" icap=%d  charge=%f\n",icap,charge);    dacval = (charge * 1023.0 ) / (2.0 * 4.096* capacitor);    if(dacval > 1023.0) dacval = 1023.0;    dac = (int) dacval;  /* conveert to int for loading dac */    charge = ( 2.0 * 4.096 * capacitor *(double)dac ) / 1023.0;    printf(" charge=%f  dacval=%f  dac=%d  cap=%f\n",           charge,dacval,dac,capacitor);    send13_3in1(6,dac);  /* set the dac */loop:        tp_high();  /* open solid state switch and start charging capacitor */        tsleep(10);   /* wait for it to charge  */        stime();    /*  ---------------------------------------------------------------------          stime() starts the controller timer           the controller waits tc clock cycles (25ns per count)          then starts the fine timer            the fine timer waits tf counts where           0<tf<255 and 255= about 50ns           when the fine timer completes, tp is set low           injecting charge and returning the shaping network           to standard data taking configuration           for stime() to work, the 40MHz ecl clock must be connected           to the front controller panel input            -------- or you can skip calling stime() and rtime()          you can just call tp_low() and inject          without all of the phasing of the signal to the digitization           clock if you wish -------------------------------------------------------------------------*/         tsleep(5); /* wait a bit */        rtime();  /* reset the charge injection timer - we call this later */                  /* to avoid digital noise at injection */       goto loop;  /* go do it again */}  /* end of main */
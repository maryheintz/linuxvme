#include <stdio.h>#include <math.h>char xstring[80],ystring[80],string[80],err[80];unsigned char gpib_adr = 4;int ent=0;main(argc,argv,envs)int argc;char *argv[];char *envs[];{    int isw[6],i1,i2,ll,i,mode,s1,s2,s3,s4,sw8,itr,ire,mse,tpe,lcal;   int sw1,dacset,max[6],del[6];   short cadr,sval,dval,tval,t1val,t2val;   double fmin,ratio,volt,ped,expr[6];   int zone,sector,card,l,gain;    zone = 1;    sector = 1;    multi_low();    printf("argc=%d\n",argc);    if(argc != 2)     { for(i=0;i<49;i++)       { card = i;         l = (zone<<12) | (sector<<6) | card;         cadr = (unsigned short)l;         card_sel(cadr);         sval = (unsigned short)0x555;         wrt_shift(13,sval);         read_shift(&dval);         printf("card=%d  sval=%x  dval=%x\n",card,(int)sval,(int)dval);         if(sval != (dval&0x1fff) ) continue;         sval = (unsigned short)0xaaa;         wrt_shift(13,sval);         read_shift(&dval);         if(sval != (dval&0x1fff) ) continue;         card = i;         goto found;       }       printf("no card found\n");       return(0);found:    printf("card %d found\n",card);    }    if(argc == 2)     { sscanf(argv[1],"%d",&card);       printf("card %d requested\n",card);}    i = (zone<<12) | (sector<<6) | card;    cadr = (unsigned short)i;   multi_low();   card_sel(cadr);   tval = (short)100;   tim1_set(tval);   tval = (short)50;   tim2_set(tval);   rtime();   max[0]=800;   max[1]=200;   max[2]=180;   max[3]=100;   max[4]=60;   max[5]=50;   del[0]=80;   del[1]=20;   del[2]=16;   del[3]=10;   del[4]=6;   del[5]=5;   expr[0]=1.0;   expr[1]=2.7;   expr[2]=3.7;   expr[3]=7.2;   expr[4]=9.7;   expr[5]=13.2;   isw[0]=0xe;   isw[1]=0xd;   isw[2]=0xf;   isw[3]=0xb;   isw[4]=0x7;   isw[5]=0x3;   for(i=0;i<6;i++)   { if(i==0) dxyset(i,(double)max[i],0.0,5.0,0.0,0,0);     if(i!=0) dxyset(i,(double)max[i],0.0,10.0,0.0,0,0);     sprintf(xstring,"isw=%x xaxis=dac value",isw[i]);     sprintf(ystring,"yaxis=volts");     dxylbl(i,xstring,ystring);    }   for(gain=0;gain<6;gain++)    {send13_3in1(2,isw[gain]);     send13_3in1(6,0);     send4_3in1(0,0);  /* intg_rd=0 */     send4_3in1(1,0);  /* itr=0 */     tsleep(0x80000020);     go_get(&ped);     printf("gain setting %d  ped=%f\n",gain,ped);     dacset = max[gain];     for(i=0;i<dacset;i=i+del[gain])              { sw1 = sw(1);         send13_3in1(6,i);         tsleep(0x80000005);         go_get(&volt);         fmin=volt-ped;         if(sw1 == 0) printf("dac=%d  volt=%f  ped=%f\n",i,volt,ped);         dxyacc(gain,(double)i,fmin,0.0,0);       }    }   send13_3in1(6,48);   send4_3in1(0,0);  /* intg_rd=0 */   send4_3in1(1,0);  /* itr=0 */   tsleep(0x80000100);   go_get(&volt);   printf("intg_rd=0 itr=0 on volt=%f\n",volt);   send4_3in1(0,0);  /* intg_rd=0 */   send4_3in1(1,1);  /* itr=1 */   tsleep(0x80000100);   go_get(&volt);   printf("intg_rd=0 itr=1 on volt=%f\n",volt);   send4_3in1(0,1);  /* intg_rd=1 */   send4_3in1(1,0);  /* itr=0 */   tsleep(0x80000100);   go_get(&volt);   printf("intg_rd=1 itr=0 on volt=%f\n",volt);loop8:   send4_3in1(0,0);  /* intg_rd=0 */   send4_3in1(1,0);  /* itr=0 */   tsleep(0x80000100);   go_get(&volt);   printf("intg_rd=0 itr=0 on volt=%f\n",volt);   sw8 = sw(8);   if(sw8 == 1)     { sleep(1);       goto loop8;     }   printf("card=%d\n",card);   printf("\n\n\n");   fflush(stdout);   sidev(1);   dxymwr(6,0,5);/*   sidev(0);   dxymwr(6,0,5);  */}/* old switch modulesw(i)  int i;  {int *adr,k,l,shft;   adr=(int *)0x80cf0000;   k=*adr;   shft=23+i;   l=(k>>shft)&1;    return(l);  }      */sw(i)   /* new switch timer module */int i;{ int k,l,shift;  unsigned short *adr;  adr = (unsigned short *)( 0xf0aa000c);  k = *adr;  shift = i-1;  l = (k>>shift) & 1;  return(l);}    go_get(v)      double *v;      {double volts;       if(ent == 0)         {gpib_reset();          sendmessage(gpib_adr,"A2 X");          tsleep(0x80000005);/*          sendmessage(gpib_adr,"A? X");          getmessage(gpib_adr, &string[0] );          printf("A2 back=%s\n",string); */          sendmessage(gpib_adr,"C X");          tsleep(0x80000005);/*          sendmessage(gpib_adr,"C? X");          getmessage(gpib_adr, &string[0] );          printf("C back=%s\n",string); */            sendmessage(gpib_adr,"R3 X");          tsleep(0x80000005);/*          sendmessage(gpib_adr,"R? X");          getmessage(gpib_adr, &string[0] );          printf("R1,3 back=%s\n",string); */          sendmessage(gpib_adr,"N1 X");          tsleep(0x80000005);/*          sendmessage(gpib_adr,"N? X");          getmessage(gpib_adr, &string[0] );          printf("N1 back=%s\n",string); */          sendmessage(gpib_adr,"G0 X");          tsleep(0x80000005);/*          sendmessage(gpib_adr,"G? X");          getmessage(gpib_adr, &string[0] );          printf("G0 back=%s\n",string); */            sendmessage(gpib_adr,"Q0 X");          tsleep(0x80000005);/*          sendmessage(gpib_adr,"Q? X");          getmessage(gpib_adr, &string[0] );          printf("Q0 back=%s\n",string); */          ent=1;         }          sendmessage(gpib_adr,"T6 X");/*          sendmessage(gpib_adr,"T? X");          getmessage(gpib_adr, &string[0] );          printf("T6 back=%s\n",string); */          tsleep(0x80000020);          getmessage(gpib_adr, &string[0] );/*          printf("first readback=%s\n",string); */          sscanf(string,"%le",&volts);/*          printf("volts=%e\n",volts);  */          *v=volts;          return(0);}      double dxyfit(l,k,x)      int l,k;      double x;      { double dxyf;        dxyf=0.0;  /* dummy routine */        return(dxyf);      }
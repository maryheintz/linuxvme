#include <stdio.h>#include <math.h>#include <time.h>int sw1,sw2,sw3,sw4,sw5,sw6,sw7,sw8;char string[10000];unsigned char gpib_angle=1,gpib_scope=2;int delay_set=2;char xstring[80],ystring[80];double sbin[500];main()  { FILE *fp;    int target,i,n,value,last,bin,sign,mbin;    double max;    short cadr,tval;    double ang;    double tstrt;    double density,trans;    tstrt=0.3601;    card_sel(cadr);    send4_3in1(4,0);     /* disable calibration */    send4_3in1(5,0);    tp_low();    send12_3in1(6,1,0);  /* fine dac=0 */    send12_3in1(6,0,0);  /* coarse dac=0 */    tval = (short)255;    tim1_set(tval);    tim2_set(tval);    fp=fopen("diode_scope.out","w");    dotset(0,300.0,100.0,10000.0,0.0,0,0);    sprintf(xstring,"scope bin (2ns/bin)");    sprintf(ystring,"amplitude (scope counts)");    dotlbl(0,xstring,ystring);    dotset(1,0.0,0.5,210.0,160.0,0,0);    sprintf(xstring,"trans");    sprintf(ystring,"mbin");    dotlbl(1,xstring,ystring);    dotset(2,0.0,0.5,10000.0,0.0,0,0);    sprintf(xstring,"trans");    sprintf(ystring,"max amplitude (scope counts)");    dotlbl(2,xstring,ystring);/* ############### set starting angle ################# */    gpib_reset();    density=-log10(tstrt);    ang=(density+1.3333)/0.014815;    target=(int)(-100.0*ang);    sprintf(string,"EP1:TA%d:GA\r",target);    sendmessage(gpib_angle,string);    sendmessage(gpib_angle,"RP1\r");    printf("sleep 5\n");    sleep(5);     trig_3in1();/* ################ start - attenuator loop ########## */   for(trans=0.3601;trans>0.0;trans=trans-0.036)     {density=-log10(trans);      ang=(density+1.3333)/0.014815;      target=(int)(-100.0*ang);      sprintf(string,"EP1:TA%d:GA\r",target);      sendmessage(gpib_angle,string);      sendmessage(gpib_angle,"RP1\r");      sleep(5);        c_latch();       sw1 = sw(1);       sw2 = sw(2);       sw3 = sw(3);       sw4 = sw(4);       sw5 = sw(5);       sw6 = sw(6);       sw7 = sw(7);       sw8 = sw(8);/*     send tp pulse ------------------------------- */       for(n=0;n<500;n++) sbin[n]=0.0;        for(n=0;n<100;n++)         {trig_3in1();         tsleep(0x80000020);/*       read scope ------------------------------- */         sendmessage(gpib_scope,"DATA:SOURCE MATH2");         sendmessage(gpib_scope,"DAT:ENC ASCI ");         sendmessage(gpib_scope,"DAT:WID 2 ");/*         sendmessage(gpib_scope,"DATA? ");         getmessage(gpib_scope,&string[0]);         printf("string=%s\n",string);  */         sendmessage(gpib_scope,"CURVE?");         getmessage(gpib_scope,&string[0]);/*         printf("string=%s\n",string); */         i=0;         last=0;         bin=0;         sign=1;         while(string[i] != '\0')          { if(string[i] != ',')              {value=0;              if(string[i] == '0') value=0;              if(string[i] == '1') value=1;              if(string[i] == '2') value=2;              if(string[i] == '3') value=3;              if(string[i] == '4') value=4;              if(string[i] == '5') value=5;              if(string[i] == '6') value=6;              if(string[i] == '7') value=7;              if(string[i] == '8') value=8;              if(string[i] == '9') value=8;              if(string[i] == '-') sign=-1;              last = last*10 + value;             }             if(string[i] == ',')              {sbin[bin]=sbin[bin]+(double)last;               last=0;               sign=1.0;               bin++;              }            i++;          }                   }  /* end of n loop */       max=0.0;       mbin=0;       for(n=0;n<500;n++)        {sbin[n]=sbin[n]/100.0;         if(sbin[n]>max)           {max=sbin[n];           mbin=n;}         dotacc(0,(double)n,sbin[n]);        }       dotacc(1,trans,(double)mbin);       dotacc(2,trans,max);     printf("ang=%f trans=%f mbin=%d max=%f\n",ang,trans,mbin,max);   }  /* end of attenuator loop */   dotwrt(0);   dotwrt(1);   dotwrt(2);   plot_reset();    printf("second chance to hard copy plots\n");    dotwrt(0);   dotwrt(1);   dotwrt(2);   density=-log10(tstrt);   ang=(density+1.3333)/0.014815;   target=(int)(-100.0*ang);   sprintf(string,"EP1:TA%d:GA\r",target);   sendmessage(gpib_angle,string);   sendmessage(gpib_angle,"RP1\r");}  /* end of main */trig_3in1(){ rtime();  stime();  return(0);}     sw(i)        int i;        {int *adr,k,l,shft;         adr=(int *)0x80cf0000;         k=*adr;         shft=23+i;         l=(k>>shft)&1;         return(l);         }           r_latch()        {int *adr,k,l;         adr=(int *)0x80cf0000;         k=*adr;         l=k&1;         return(l);         }           c_latch()        {int *adr,k,l;         adr=(int *)0x80cf0008;         *adr=NULL;         return(0);         }           s_trig()        {int *adr,k,l;/*         printf(" sending trigger at adr 80cf0004\n"); */         adr=(int *)0x80cf0004;         *adr=NULL;         return(0);         }      
#include <stdio.h>#include <math.h>char string[100000];char xstring[80],ystring[80];unsigned char gpib_scope = 1;double sbin[500],asum[500];main() {    int sw1,nev;   unsigned short cadr,tc,tf;   int zone,sector,card;   int l,dac_fine,dac_coarse;   int i,last,bin,sign,value,n,mbin;   double charge,fd,cd,max;   double volts,sum,xsum,xxsum,dac,mean,sig,sig2,scale;   gpib_reset();   dotset(0,500.0,0.0,100.0,0.0,0,0);   sprintf(xstring,"scope bin ( ns )");   sprintf(ystring,"amplitude (scope counts)");   dotlbl(0,xstring,ystring);   zone = 0;   sector = 0;   card = 1;   l = (zone<<12) | (sector<<6) | card;   cadr = (short)l;   card_sel(cadr);   send12_3in1(2,0,0);   /* s1=s2=s3=s4=0 */   send4_3in1(1,0);   /* itr=0 */   send4_3in1(0,0);   /* ire=0 */   send4_3in1(3,0);   /* mse=0 */   send4_3in1(4,1);   /* tpe=1 */   send4_3in1(5,0);   /* lcal=0 */    tf = 0;    tim2_set(tf);   /* fine */    tc = 2;    tim1_set(tc);    tp_low();    rtime();    charge = 300.0;    dac_fine = 255;    fd = (double)dac_fine;    cd = (charge * 255.0 * 255.0)/(5.0*128.0*fd);    dac_coarse = (int)cd;    send12_3in1(6,1,dac_fine);   /* set dac_fine value */    send12_3in1(6,0,dac_coarse);   /* set dac_coarse value */    printf(" dacf=%d  dacc=%d  charge=%f\n",dac_fine,dac_coarse,charge);    for(l=0;l<500;l++) asum[l]=0.0;     for(nev=0;nev<100;nev++)      { tp_high();        tsleep(0x80000010);        stime();        tsleep(0x80000002);        rtime();/*    read scope ------------------------------- */        sendmessage(gpib_scope,"DAT:WID 2");        sendmessage(gpib_scope,"DAT:ENC ASCI");        sendmessage(gpib_scope,"DATA:SOURCE MATH2");        sendmessage(gpib_scope,"CURVE?");        getmessage(gpib_scope,&string[0]);        i=0;        last=0;        bin=0;        sign=1;        while(string[i] != '\0')         {if(string[i] != ',')            {value=0;            if(string[i] == '0') value=0;            if(string[i] == '1') value=1;            if(string[i] == '2') value=2;            if(string[i] == '3') value=3;            if(string[i] == '4') value=4;            if(string[i] == '5') value=5;            if(string[i] == '6') value=6;            if(string[i] == '7') value=7;            if(string[i] == '8') value=8;            if(string[i] == '9') value=8;            if(string[i] == '-') sign=-1;            last = last*10 + value;           }           if(string[i] == ',')              {sbin[bin]=sbin[bin]+(double)last;               last=0;               sign=1.0;               bin++;              }            i++;        }  /* end of while */                   max=0.0;       mbin=0;       for(n=0;n<500;n++)        {sbin[n]=sbin[n]/100.0;         if(sbin[n]>max)           {max=sbin[n];           mbin=n;}          asum[n]=asum[n]+sbin[n];        }       } /* end of nev loop */       for(l=0;l<500;l++)  dotacc(0,(double)l,asum[l]/100.0);/*     printf("charge=%f  max=%f\n",charge,max); */     dotwrt(0);     plot_reset();      printf("second chance to hard copy plots\n");      dotwrt(0);    return(0);}     sw(i)        int i;        {int *adr,k,l,shft;         adr=(int *)0x80cf0000;         k=*adr;         shft=23+i;         l=(k>>shft)&1;         return(l);         }      
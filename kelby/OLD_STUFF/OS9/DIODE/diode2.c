#include <stdio.h>#include <math.h>#include <time.h>int sw1,sw2,sw3,sw4,sw5,sw6,sw7,sw8;int fdata[512];struct{unsigned int trig;       unsigned int reset;       unsigned int status;       unsigned int sample;       unsigned int delay;       unsigned int rdall;       unsigned int rd3;       unsigned int rd2;       unsigned int rd1;}fermi;unsigned short *reg;unsigned int base=0xf0b40000;unsigned int base2=0x80b40000;int lo[32],hi[32],qlo[32],qhi[32];char xstring[80],ystring[80],err[80];unsigned char gpib_device=1;int delay_set=2;main()  { FILE *fp,*fpout;    int ncia=16,target;    int nevnt,nevmax,nstrtev,l,nn,i,k,kk;    int ipeak,peak_val,nloop,kkkcnt,kkk,nrl;    short cadr,tval;    unsigned short cia,data;    unsigned long ext,b,c,n,a,f,q,off;    double fval,sum,sig2,sig;    double fmean,fsig,fxsum,fxxsum;    double lot1,l1mean,l1sig,l1xsum,l1xxsum;        double lot2,l2mean,l2sig,l2xsum,l2xxsum;        double hit1,h1mean,h1sig,h1xsum,h1xxsum;        double hit2,h2mean,h2sig,h2xsum,h2xxsum;        double ang,ang1,ang2,fn1,fn2,aa,bb;    double xhist,yhist;    double astrt,ykk;    double asum,axsum,axxsum,aval,ratio;    double density,trans;    int tube1,tube2;    fp=fopen("diode.set","r");    fscanf(fp,"%d %d %lf",&tube1,&tube2,&astrt);    printf("tube1=%d tube2=%d astrt=%f\n",tube1,tube2,astrt);    /* --------------- INITIALIZE CAMAC --------------------------------*/    printf("initialize camac\n");    b=0;    c=1;    n=7;    a=0;    /*  set up control word ext */    cdreg(&ext,&b,&c,&n,&a);    off=0;    cccz(&ext);          /* initialize */     cccc(&ext);          /* clear */    ccci(&ext,&off);     /* remove crate inhibit */    /*  send pulse to cia clear input */    f=16;    a=7;    n=2;    data=0x8000;    cdreg(&ext,&b,&c,&n,&a);    cssa(&f,&ext,&data,&q);    /* clear the cia lam */    n=ncia;    a=0;    f=9;    cdreg(&ext,&b,&c,&n,&a);    cssa(&f,&ext,&cia,&q);/*  send pulse to reset visual scaler */    f=16;    a=7;    n=2;    data=1;    cdreg(&ext,&b,&c,&n,&a);    cssa(&f,&ext,&data,&q);    printf(" set card_sel and tim1 value\n");    cadr = 1;    card_sel(cadr);    send4_3in1(4,0);     /* disable tp pulses */    tp_low();    send12_3in1(6,1,0);  /* fine dac=0 */    send12_3in1(6,0,0);  /* coarse dac=0 */    tval = (short)255;    tim1_set(tval);    tim2_set(tval);    nevmax=5000;    printf(" set up plots\n");        dotset(0,400.0,0.0,2.0,0.0,0,0);        sprintf(xstring,"angle");        sprintf(ystring,"fermi-1/fermi+1");        dotlbl(0,xstring,ystring);        dotset(1,1.0,0.0,1000.0,0.0,0,0);        sprintf(xstring,"I(transmitted)");        sprintf(ystring,"fermi mean");        dotlbl(1,xstring,ystring);        dotset(7,400.0,0.0,1000.0,0.0,0,0);        sprintf(xstring,"angle");        sprintf(ystring,"fermi mean");        dotlbl(7,xstring,ystring);        dotset(8,2500.0,0.0,1000.0,0.0,0,0);        sprintf(xstring,"tube1 mean");        sprintf(ystring,"fermi mean");        dotlbl(8,xstring,ystring);    printf(" read switches\n");/*  read switches */    sw1 = sw(1);    sw2 = sw(2);    sw3 = sw(3);    sw4 = sw(4);    sw5 = sw(5);    sw6 = sw(6);    sw7 = sw(7);    sw8 = sw(8);    printf("switches  1-8= %d %d %d %d %d %d %d %d\n",      sw1,sw2,sw3,sw4,sw5,sw6,sw7,sw8);    printf(" reset fermi and clear trig\n");    f_reset();    f_ctrig();/* ############### set starting angle ################# */    fpout=fopen("diode.dat","w");    gpib_reset();    target=(int)(-100.0*astrt);    sprintf(xstring,"EP1:TA%d:GA\r",target);    sendmessage(gpib_device,xstring);    sendmessage(gpib_device,"RP1\r");    printf("sleep 5\n");    sleep(5); /* ################ start - throw away several event to get going ########## */    trig_3in1();    f_reset();    f_ctrig();    trig_3in1();    f_reset();    f_ctrig();    trig_3in1();    f_reset();    f_ctrig();    trig_3in1();    f_reset();    f_ctrig();/* ################ start - attenuator loop ########## */   for(ang=astrt;ang<355.0;ang=ang+1.0)     {if(sw7 == 1)        { printf(" input next angle \n");         fscanf(stdin,"%lf",&ang); }      target=(int)(-100.0*ang);      sprintf(xstring,"EP1:TA%d:GA\r",target);      sendmessage(gpib_device,xstring);      sendmessage(gpib_device,"RP1\r");/*  send pulse to reset visual scaler */      f=16;      a=7;      n=2;      data=1;      cdreg(&ext,&b,&c,&n,&a);      cssa(&f,&ext,&data,&q);      sleep(1);       k++;      l=-1;      nevmax=25;      asum=0.0;      axsum=0.0;      axxsum=0.0;      sum = 0.0;      fxsum = 0.0;      fxxsum = 0.0;      l1xsum = 0.0;      l1xxsum = 0.0;          l2xsum = 0.0;      l2xxsum = 0.0;          h1xsum = 0.0;      h1xxsum = 0.0;          h2xsum = 0.0;      h2xxsum = 0.0;    /*      printf("ang=%f  target=%d nevmax=%d\n",ang,target,nevmax); */     for(nevnt=0;nevnt<nevmax;nevnt++)      {/*   reset last event ------------------------------ */rstrt:       f_ctrig();       c_latch();       sw1 = sw(1);       sw2 = sw(2);       sw3 = sw(3);       sw4 = sw(4);       sw5 = sw(5);       sw6 = sw(6);       sw7 = sw(7);       sw8 = sw(8);       /* reset the cia */       n=ncia;       a=0;       f=9;       cdreg(&ext,&b,&c,&n,&a);       cssa(&f,&ext,&cia,&q);       /*  send pulse to cia clear input */       f=16;       a=7;       n=2;       data=0x8000;       cdreg(&ext,&b,&c,&n,&a);       cssa(&f,&ext,&data,&q);/*     send tp pulse ------------------------------- */       trig_3in1();       tsleep(0x80000020);/*     look for latch bit set ------------------------------- */       kkkcnt=0;loop:       kkk=r_latch();       kkkcnt++;       if(kkkcnt>1000)         {nrl++;         goto rstrt;}       if(kkk != 1) goto loop;/*     go read the fermi module ------------------------------- */       f_read(&ipeak,&peak_val);       if(sw1 == 1 )          {hstrst();/*           hstset(0,250.0,0.0,250,1000); */           hstset(0,50.0,0.0,50,1000);           fval=(double)fdata[ipeak+1]/(double)fdata[ipeak-1];           sprintf(xstring,"ipeak=%d peak_val=%d lot1=%d f+1/f-1=%f",             ipeak,peak_val,(int)lot1,fval);           hstlbl(0,xstring);           for(nn=0; nn<256; nn++)            {xhist = (double)nn + 0.5;             yhist = (double)fdata[nn];             hstacc(0,xhist,yhist);            }         hstwrt(0);         }/*     read the cia module ------------------------------- */       /*  test for lam in cia */       n=ncia;       a=0;       cdreg(&ext,&b,&c,&n,&a);       f=8;       nloop=0;loop1:       cssa(&f,&ext,&cia,&q);       nloop++;       if( (q == 0) && (nloop<1000) ) goto loop1;       /*   read the cia module */       f=2;       for(i=0; i<32; i++)       { cia=0;         /*  read first channel */         cssa(&f,&ext,&cia,&q);         lo[i] = (cia & 0xfff);         qlo[i]=-q;         cssa(&f,&ext,&cia,&q);         hi[i] = (cia & 0xfff);         qhi[i]=-q;         if(sw6 == 1) printf("i=%d lo=%d qlo=%d hi=%d qhi=%d\n",           i,lo[i],qlo[i],hi[i],qhi[i]);       }         if(sw2 == 1)           { printf("ipeak=%d fermi= %d %d %d\n",              ipeak,fdata[ipeak-1],fdata[ipeak],fdata[ipeak+1]);            printf("tube1 lo=%d qlo=%d hi=%d qhi=%d\n",            lo[12],qlo[12],hi[12],qhi[12]);            printf("tube2 lo=%d qlo=%d hi=%d qhi=%d\n",            lo[13],qlo[13],hi[13],qhi[13]);}       if(sw8 == 1) goto rstrt;       l++;/*    pick out the cia channels being used for tube 1 and tube 2 */       lot1=(double)lo[tube1];       hit1=(double)hi[tube1];       lot2=(double)lo[tube2];       hit2=(double)hi[tube2];/*  do plots */       ratio=(double)fdata[ipeak-1]/(double)fdata[ipeak+1];       dotacc(0,ang,ratio);       asum=asum+1.0;       aval=(double)fdata[ipeak];       axsum=axsum+aval;       axxsum=axxsum+aval*aval;       l1xsum=l1xsum+lot1;   if(sw3 == 1)    {printf("f=%10d l1=%10.3f l2=%10.3f h1=%10.3f h2=%10.3f\n",          fdata[ipeak],lot1,lot2,hit1,hit2);}     } /* end of nevnt loop */   aval=axsum/asum;   dotacc(7,ang,aval);   fval=l1xsum/asum;   dotacc(8,fval,aval);   density = 0.014815*ang-1.33333;   trans=1.0;   if(density>0.00001) trans=pow(10.0,-density);   dotacc(1,trans,aval);   printf("ang=%f trans=%f fermi=%f cia1=%f\n",ang,trans,aval,fval);    fflush(stdout);   fprintf(fpout,"%15.5f %14.5f %14.5f %14.5f\n",ang,trans,aval,fval);    i++;   }  /* end of attenuator loop */   target=(int)(-100.0*astrt);   sprintf(xstring,"EP1:TA%d:GA\r",target);   sendmessage(gpib_device,xstring);   sendmessage(gpib_device,"RP1\r");   dotwrt(1);   dotwrt(7);   dotwrt(8);   dotwrt(0);   plot_reset();    printf("second chance to hard copy plots\n");    dotwrt(1);   dotwrt(7);   dotwrt(8);   dotwrt(0);}  /* end of main */trig_3in1(){ rtime();  stime();  return(0);}    double hstfit(i,l,x)    int i,l;    double x;    {double y;     y=0.0;     return(y);     }       sw(i)        int i;        {int *adr,k,l,shft;         adr=(int *)0x80cf0000;         k=*adr;         shft=23+i;         l=(k>>shft)&1;         return(l);         }           r_latch()        {int *adr,k,l;         adr=(int *)0x80cf0000;         k=*adr;         l=k&1;         return(l);         }           c_latch()        {int *adr,k,l;         adr=(int *)0x80cf0008;         *adr=NULL;         return(0);         }           s_trig()        {int *adr,k,l;/*         printf(" sending trigger at adr 80cf0004\n"); */         adr=(int *)0x80cf0004;         *adr=NULL;         return(0);         }      f_reset(){ FPermit(base,0x100,3);  FPermit(base2,0x100,3);  fermi.trig=base+0x26;  fermi.reset=base+0x24;  fermi.status=base+0x22;  fermi.sample=base+0x20;  fermi.delay=base+0x1e;  fermi.rdall=base2+0x18;  fermi.rd3=base+0x14;  fermi.rd2=base+0x12;  fermi.rd1=base+0x10;  /* issue reset */  reg=(unsigned short *)fermi.reset;  *reg=0;  /* set to full 255 samples */  reg=(unsigned short *)fermi.sample;  *reg=255;  /* set delay */  reg=(unsigned short *)fermi.delay;  *reg=delay_set;  return(0);}f_ctrig(){  /* printf(" write null to %x\n",fermi.trig); */   reg=(unsigned short *)fermi.trig;  *reg=0;  return(0);}f_read(peak,peak_val)int *peak,*peak_val;{int stat,data_ready,busy,lcnt,i,dd,k,kmax; /* wait for a trigger */  lcnt=0;loop:  lcnt++;  reg = (unsigned short *)fermi.status;  stat = *reg;  data_ready = stat & 4;  busy = stat & 2;  if(lcnt > 1000 ) goto error;  if ( data_ready == 0 ) goto loop;  /* read the data and find peak channel */  k=0;  kmax=0;  for (i=0;i<255;i++)   {    reg=(unsigned short *) fermi.rd3;/*    printf(" i=%d  fermi=%x\n",i,*reg); */    dd = *reg & 0x3ff;    fdata[i] = dd;    if(sw4 == 1) printf("i=%d  fdata=%d\n",i,dd);    if(i == 0) fdata[i]=0;    if(fdata[i]>kmax)     {kmax=fdata[i];      k=i;}   }   *peak=k;   *peak_val=kmax;   return(0);error:   *peak=-1;   return(0);   }
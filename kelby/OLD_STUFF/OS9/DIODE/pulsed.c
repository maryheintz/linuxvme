#include <stdio.h>#include <math.h>#include <time.h>int sw1,sw2,sw3,sw4,sw5,sw6,sw7,sw8;int fdata[512];struct{unsigned int trig;       unsigned int reset;       unsigned int status;       unsigned int sample;       unsigned int delay;       unsigned int rdall;       unsigned int rd3;       unsigned int rd2;       unsigned int rd1;}fermi;unsigned short *reg;unsigned int base=0xf0b40000;unsigned int base2=0x80b40000;char xstring[80],ystring[80],err[80];unsigned char gpib_device=1;int delay_set=2;int ipeak,peak_val;double nbf,xbf,x2bf,naf,xaf,x2af,mbf,maf,sigbf,sigaf,val,peddif;main()  { int i,plot;    short cadr,tval;    double sig2;    double astrt;    double density,trans,target;    cadr = 1;    card_sel(cadr);    send4_3in1(4,0);     /* disable tp pulses */    tp_low();    send12_3in1(6,1,0);  /* fine dac=0 */    send12_3in1(6,0,0);  /* coarse dac=0 */    tval = (short)255;    tim1_set(tval);    tim2_set(tval);    printf("input angle\n");    fscanf(stdin,"%lf",&astrt);    printf("plot events 0=no 1=yes\n");    fscanf(stdin,"%d",&plot);    gpib_reset();    target=(int)(-100.0*astrt);    sprintf(xstring,"EP1:TA%d:GA\r",target);    sendmessage(gpib_device,xstring);    sendmessage(gpib_device,"RP1\r");next:    f_reset();   stime();   tsleep(0x80000010);   f_read();   if(plot == 1 )    { nbf=0.0;      xbf=0.0;      x2bf=0.0;      naf=0.0;      xaf=0.0;      x2af=0.0;      for(i=0;i<100;i++)       { nbf=nbf+1.0;         val = (double)fdata[i];         xbf = xbf + val;         x2bf = x2bf + val*val;         naf = naf + 1.0;         val = (double)fdata[i+150];         xaf = xaf + val;         x2af = x2af + val*val;       }      mbf = xbf/nbf;      sigbf=0.0;      sig2=x2bf/nbf-mbf*mbf;      if(sig2>0.0) sigbf=sqrt(sig2);      maf = xaf/naf;      sigaf=0.0;      sig2=x2af/naf-maf*maf;      if(sig2>0.0) sigaf=sqrt(sig2);      peddif=mbf-maf;      evdisp(250);    }    goto next;  }  /* end of main */sw(i) int i; { int *adr,k,l,shft;/*   adr=(int *)0x80cf0000;   k=*adr;   shft=23+i;   l=(k>>shft)&1;  */   l = 0;   return(l); }      f_reset(){ FPermit(base,0x100,3);  FPermit(base2,0x100,3);  fermi.trig=base+0x26;  fermi.reset=base+0x24;  fermi.status=base+0x22;  fermi.sample=base+0x20;  fermi.delay=base+0x1e;  fermi.rdall=base2+0x18;  fermi.rd3=base+0x14;  fermi.rd2=base+0x12;  fermi.rd1=base+0x10;  /* issue reset */  reg=(unsigned short *)fermi.reset;  *reg=0;  /* set to full 255 samples */  reg=(unsigned short *)fermi.sample;  *reg=255;  /* set delay */  reg=(unsigned short *)fermi.delay;  *reg=delay_set;  return(0);}f_read(){int stat,data_ready,busy,lcnt,i,dd,k,kmax; /* wait for a trigger */  lcnt=0;loop:  lcnt++;  reg = (unsigned short *)fermi.status;  stat = *reg;  data_ready = stat & 4;  busy = stat & 2;  if(lcnt > 1000 ) goto error;  if ( data_ready == 0 ) goto loop;  /* read the data and find peak channel */  k=0;  kmax=0;  reg=(unsigned short *) fermi.rd3;  for (i=0;i<255;i++)   {    dd = *reg & 0x3ff;    fdata[i] = dd;/*    if(i == 0) fdata[i]=0; */    if(fdata[i]>kmax)     {kmax=fdata[i];      k=i;}   }   ipeak=k;   peak_val=kmax;   return(0);error:   ipeak=-1;   return(0);}   evdisp(nn)int nn; { int max,mmax,idx,idy,ny,linx,ixbas,iybas,ix,iy,iylst,kx,ky,i,k,ii;   int idel;   double dely,y,dy;   char str[5];   erasm();   max = peak_val;   mmax=1200;   if(max<1000) mmax=1000;   if(max<800) mmax=800;   if(max<600) mmax=600;   if(max<500) mmax=500;   if(max<400) mmax=400;   if(max<200) mmax=200;   if(max<100) mmax=100;   if(max<50) mmax=50;   idx = 1600/nn;   linx = idx*nn;   ixbas = 100+(2200-linx)/2;   dy = 2400.0/(double)mmax;   iybas = 400;   mova(ixbas,iybas);   drwr(linx,0);   mova(ixbas,iybas);   iylst = 0;   for(i=0;i<nn;i++)    { ii = fdata[i];      y = (double)ii;      y = y*dy;      iy = (int)y;      idy = iy-iylst;      drwr(0,idy);      drwr(idx,0);      iylst=iy;    }      drwr(0,-iylst);/*  label horizontal axis */    idel=10;    if(nn>100) idel=25;    if(nn>200) idel=50;    for(i=0;i<nn+1;i=i+idel)     { ix=ixbas+idx*i;       mova(ix,iybas);       drwr(0,-30);       k=i/2;       if(k*2 == i)         { sprintf(str,"%3d",i);           kx = ix-45;           if(i<100) kx = ix-55;           if(i<10) kx=ix-75;           symb(kx,iybas-100,0.0,str);         }     }/*  label vertical axis  */    ny=mmax/100;    if(mmax == 200) ny=4;    if(mmax == 100) ny=4;    if(mmax == 50) ny=5;    y=(double)mmax*dy;    iy = (int)y;    mova(ixbas,iybas);    drwr(0,iy);    for(i=0;i<=ny;i++)     { ky = i*mmax/ny;       y = (double)ky * dy;       iy = (int)y + iybas;       mova(ixbas,iy);       drwr(-20,0);       sprintf(str,"%4d",ky);       kx = ixbas-150;       symb(kx,iy-20,0.0,str);     }/*  print label */    addlabel();    plotmx();}    addlabel()     { char string[80];       sprintf(string,"pedistal before peak=%5.2f +/- %5.2f",mbf,sigbf);       symb(500,3000,0.0,string);       sprintf(string,"pedistal after peak=%5.2f +/- %5.2f",maf,sigaf);       symb(500,2950,0.0,string);       sprintf(string,"pedistal shift=%5.2f ",peddif);       symb(500,2900,0.0,string);       sprintf(string,"ipeak=%d peak_val=%d",ipeak,peak_val);       symb(700,2850,0.0,string);    }
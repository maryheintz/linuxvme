#include <stdio.h>#include <math.h>#include <time.h>int sw1,sw2,sw3,sw4,sw5,sw6,sw7,sw8;int lo[32],hi[32],qlo[32],qhi[32];char xstring[80],ystring[80],err[80];unsigned char gpib_device=1;unsigned short *reg;main()  { FILE *fp,*fpout;    int ncia=16,target;    int nevnt,nevmax,nstrtev,l,i,k,kk;    int ipeak,peak_val,nloop,kkkcnt,kkk,nrl;    short cadr,tval;    unsigned short cia,data;    unsigned long ext,b,c,n,a,f,q,off;    double fval,sum,sig2,sig;    double fmean,fsig,fxsum,fxxsum;    double lot1,l1mean,l1sig,l1xsum,l1xxsum;        double lot2,l2mean,l2sig,l2xsum,l2xxsum;        double hit1,h1mean,h1sig,h1xsum,h1xxsum;        double hit2,h2mean,h2sig,h2xsum,h2xxsum;        double cia1,cia2,scia1,scia2;    double ang,ang1,ang2,fn1,fn2,aa,bb;    double astrt,ykk;    double asum,axsum,axxsum,aval,ratio;    double density,trans;    int tube1,tube2;    fp=fopen("diode.set","r");    fscanf(fp,"%d %d",&tube1,&tube2);    printf("tube1=%d tube2=%d\n",tube1,tube2);    /* --------------- INITIALIZE CAMAC --------------------------------*/    printf("initialize camac\n");    b=0;    c=1;    n=7;    a=0;    /*  set up control word ext */    cdreg(&ext,&b,&c,&n,&a);    off=0;    cccz(&ext);          /* initialize */     cccc(&ext);          /* clear */    ccci(&ext,&off);     /* remove crate inhibit */    /*  send pulse to cia clear input */    f=16;    a=7;    n=2;    data=0x8000;    cdreg(&ext,&b,&c,&n,&a);    cssa(&f,&ext,&data,&q);    /* clear the cia lam */    n=ncia;    a=0;    f=9;    cdreg(&ext,&b,&c,&n,&a);    cssa(&f,&ext,&cia,&q);/*  send pulse to reset visual scaler */    f=16;    a=7;    n=2;    data=1;    cdreg(&ext,&b,&c,&n,&a);    cssa(&f,&ext,&data,&q);    printf(" set card_sel and tim1 value\n");    cadr = 1;    card_sel(cadr);    send4_3in1(4,0);     /* disable tp pulses */    tp_low();    send12_3in1(6,1,0);  /* fine dac=0 */    send12_3in1(6,0,0);  /* coarse dac=0 */    tval = (short)255;    tim1_set(tval);    tim2_set(tval);    nevmax=5000;    printf(" set up plots\n");        dotset(0,4000.0,0.0,4000.0,0.0,0,0);        sprintf(xstring,"cia1");        sprintf(ystring,"cia2");        dotlbl(0,xstring,ystring);        dotset(1,1.0,0.0,4000.0,0.0,0,0);        sprintf(xstring,"trans");        sprintf(ystring,"cia1");        dotlbl(1,xstring,ystring);        dotset(2,1.0,0.0,4000.0,0.0,0,0);        sprintf(xstring,"trans");        sprintf(ystring,"cia2");        dotlbl(2,xstring,ystring);    printf(" read switches\n");/*  read switches */    sw1 = sw(1);    sw2 = sw(2);    sw3 = sw(3);    sw4 = sw(4);    sw5 = sw(5);    sw6 = sw(6);    sw7 = sw(7);    sw8 = sw(8);    printf("switches  1-8= %d %d %d %d %d %d %d %d\n",      sw1,sw2,sw3,sw4,sw5,sw6,sw7,sw8);    printf(" reset fermi and clear trig\n");    f_ctrig();/* ############### set starting angle ################# */    fpout=fopen("cia.dat","w");    gpib_reset();    astrt=95.0;    target=(int)(-100.0*astrt);    sprintf(xstring,"EP1:TA%d:GA\r",target);    sendmessage(gpib_device,xstring);    sendmessage(gpib_device,"RP1\r");    printf("sleep 5\n");    sleep(5); /* ################ start - throw away several event to get going ########## */    trig_3in1();    f_ctrig();    trig_3in1();    f_ctrig();    trig_3in1();    f_ctrig();    trig_3in1();    f_ctrig();/* ################ start - attenuator loop ########## */   for(ang=astrt;ang<355.0;ang=ang+1.0)     {if(sw7 == 1)        { printf(" input next angle \n");         fscanf(stdin,"%lf",&ang); }      target=(int)(-100.0*ang);      sprintf(xstring,"EP1:TA%d:GA\r",target);      sendmessage(gpib_device,xstring);      sendmessage(gpib_device,"RP1\r");      sleep(2); /*  send pulse to reset visual scaler */      f=16;      a=7;      n=2;      data=1;      cdreg(&ext,&b,&c,&n,&a);      cssa(&f,&ext,&data,&q);      k++;      l=-1;      nevmax=25;      asum=0.0;      axsum=0.0;      axxsum=0.0;      sum = 0.0;      fxsum = 0.0;      fxxsum = 0.0;      l1xsum = 0.0;      l1xxsum = 0.0;          l2xsum = 0.0;      l2xxsum = 0.0;          h1xsum = 0.0;      h1xxsum = 0.0;          h2xsum = 0.0;      h2xxsum = 0.0;         for(nevnt=0;nevnt<nevmax;nevnt++)      {/*   reset last event ------------------------------ */rstrt:       c_latch();       sw1 = sw(1);       sw2 = sw(2);       sw3 = sw(3);       sw4 = sw(4);       sw5 = sw(5);       sw6 = sw(6);       sw7 = sw(7);       sw8 = sw(8);       /* reset the cia */       n=ncia;       a=0;       f=9;       cdreg(&ext,&b,&c,&n,&a);       cssa(&f,&ext,&cia,&q);       /*  send pulse to cia clear input */       f=16;       a=7;       n=2;       data=0x8000;       cdreg(&ext,&b,&c,&n,&a);       cssa(&f,&ext,&data,&q);/*     send tp pulse ------------------------------- */       trig_3in1();       tsleep(0x80000005);/*     look for latch bit set ------------------------------- */       kkkcnt=0;loop:       kkk=r_latch();       kkkcnt++;       if(kkkcnt>1000)         {nrl++;         goto rstrt;}       if(kkk != 1) goto loop;/*     read the cia module ------------------------------- */       /*  test for lam in cia */       n=ncia;       a=0;       cdreg(&ext,&b,&c,&n,&a);       f=8;       nloop=0;loop1:       cssa(&f,&ext,&cia,&q);       nloop++;       if( (q == 0) && (nloop<1000) ) goto loop1;       /*   read the cia module */       f=2;       for(i=0; i<32; i++)       { cia=0;         /*  read first channel */         cssa(&f,&ext,&cia,&q);         lo[i] = (cia & 0xfff);         qlo[i]=-q;         cssa(&f,&ext,&cia,&q);         hi[i] = (cia & 0xfff);         qhi[i]=-q;         if(sw6 == 1) printf("i=%d lo=%d qlo=%d hi=%d qhi=%d\n",           i,lo[i],qlo[i],hi[i],qhi[i]);       }       if(sw8 == 1) goto rstrt;       l++;/*    pick out the cia channels being used for tube 1 and tube 2 */       lot1=(double)lo[tube1];       hit1=(double)hi[tube1];       lot2=(double)lo[tube2];       hit2=(double)hi[tube2];       asum=asum+1.0;       l1xsum=l1xsum+lot1;       l1xxsum=l1xxsum+lot1*lot1;       l2xsum=l2xsum+lot2;       l2xxsum=l2xxsum+lot2*lot2;   if(sw3 == 1)    {printf("l1=%10.3f l2=%10.3f h1=%10.3f h2=%10.3f\n",          lot1,lot2,hit1,hit2);}     } /* end of nevnt loop */   cia1=l1xsum/asum;   scia1=0.0;   sig2=l1xxsum/asum-cia1*cia1;   if(sig2>0.0) scia1=sqrt(sig2);   cia2=l2xsum/asum;   scia2=0.0;   sig2=l2xxsum/asum-cia2*cia2;   if(sig2>0.0) scia2=sqrt(sig2);   dotacc(0,cia1,cia2);   density = 0.014815*ang-1.33333;   trans=1.0;   if(density>0.00001) trans=pow(10.0,-density);   dotacc(1,trans,cia1);   dotacc(2,trans,cia2);   fprintf(fpout,"%10.3f %9.6f %9.3f %9.3f\n",ang,trans,cia1,cia2);   printf("ang=%f  trans=%f\n   cia1=%f scia1=%f\n   cia2=%f scia2=%f\n",      ang,trans,cia1,scia1,cia2,scia2);   i++;   }  /* end of attenuator loop */   target=(int)(-100.0*astrt);   sprintf(xstring,"EP1:TA%d:GA\r",target);   sendmessage(gpib_device,xstring);   sendmessage(gpib_device,"RP1\r");   dotwrt(0);   dotwrt(1);   dotwrt(2);   plot_reset();    printf("second chance to hard copy plots\n");    dotwrt(0);   dotwrt(1);   dotwrt(2);}  /* end of main */trig_3in1(){ rtime();  stime();  return(0);}    double hstfit(i,l,x)    int i,l;    double x;    {double y;     y=0.0;     return(y);     }       sw(i)        int i;        {int *adr,k,l,shft;         adr=(int *)0x80cf0000;         k=*adr;         shft=23+i;         l=(k>>shft)&1;         return(l);         }           r_latch()        {int *adr,k,l;         adr=(int *)0x80cf0000;         k=*adr;         l=k&1;         return(l);         }           c_latch()        {int *adr,k,l;         adr=(int *)0x80cf0008;         *adr=NULL;         return(0);         }           s_trig()        {int *adr,k,l;/*         printf(" sending trigger at adr 80cf0004\n"); */         adr=(int *)0x80cf0004;         *adr=NULL;         return(0);         }      f_ctrig(){ reg=(unsigned short *)0xf0b40026;  *reg=0;  return(0);}
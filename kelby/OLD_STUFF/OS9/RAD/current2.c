#include <stdio.h>#include <math.h>#include <time.h>int year,month,day,hour,min,sec;struct sgtbuf timebuf;double volt[8],current[8];unsigned char gpib_adr = 3;double rad_now,rad,resistor=3.4,dose;char xstring[80],ystring[80],string[80];main()  { FILE *fp;    int wait,i;    double t0,tnow,tlast,tstart,rad_now,dt,dmin,trun,minutes;    double distance=250.0;    printf("input file name\n");    fscanf(stdin,"%s",string);    fp = fopen(string,"w");    tepoc(98,5,12,12,0,0,&t0);    for(i=0;i<8;i++)      { dotset(i,10.0,0.0,50.0,0.0,0,0);        sprintf(xstring,"Rads");        sprintf(ystring,"current [ma]");        dotlbl(i,xstring,ystring);      }    newtime();    tepoc(year,month,day,hour,min,sec,&tnow);    dt = tnow-t0;    rad_now = 20.3 * exp((-0.693 * dt) / 1925.1);    printf(" rad_now = %f  td = %f  t0=%f  tnow=%f\n",rad_now,dt,t0,tnow);/*  now apply distance factor */    rad_now = (rad_now*97.0*97.0) / (distance*distance);    printf(" after distance correction rad_now=%f  dist=%f / 97\n",         rad_now,distance);    newtime();    get_volts(0);    dmin = 0.0;    dose = 0.0;    minutes = 0.0;    for(i=0;i<8;i++) current[i] = 1000.0 * volt[i] / resistor;    if(sw(5) == 1)    fprintf(fp,"dmin=%f  dose=%f  minutes=%f \n current=%f %f %f %f\n         %f %f %f %f \n",            dmin,dose,minutes,            current[0],current[1],current[2],current[3],            current[4],current[5],current[6],current[7]);      printf("dmin=%f  dose=%f  minutes=%f \n current=%f %f %f %f\n         %f %f %f %f \n",            dmin,dose,minutes,            current[0],current[1],current[2],current[3],            current[4],current[5],current[6],current[7]);  /*    plot_s();    print_currents();  */    tlast = tnow;    printf(" raise source and enter 1\n");    fscanf(stdin,"%d",&wait);    newtime();    tepoc(year,month,day,hour,min,sec,&tnow);    tstart = tnow;next:    sleep(10);    if(sw(1) == 1) for(i=0;i<8;i++) dotwrt(i);    newtime();    tepoc(year,month,day,hour,min,sec,&tnow);    dt = tnow-tlast;    dmin = dt * 1440.0;  /* convert to minutes */    if(sw(7) == 1) printf("tnow=%f  tlast=%f  dt=%f dmin=%f\n",         tnow,tlast,dt,dmin);    tlast = tnow;    get_volts(1);    for(i=0;i<8;i++) current[i] = 1000.0 * volt[i] / resistor;    trun = tnow-tstart;    dose = rad_now * trun * 24.0;    minutes = trun * 1440.0;    for(i=0;i<8;i++) dotacc(i,dose,current[i],0.0);    if(sw(5) == 1)    fprintf(fp,"dmin=%f  dose=%f  minutes=%f \n current=%f %f %f %f\n         %f %f %f %f \n",            dmin,dose,minutes,            current[0],current[1],current[2],current[3],            current[4],current[5],current[6],current[7]);      printf("dmin=%f  dose=%f  minutes=%f \n current=%f %f %f %f\n         %f %f %f %f \n",            dmin,dose,minutes,            current[0],current[1],current[2],current[3],            current[4],current[5],current[6],current[7]);  /*    plot_currents();    print_currents();  */        if(sw(8) == 0) goto next;    close(fp);  }  /* end of main */    get_volts(ent)      int ent;      {int i;       char string[200];       if(ent == 0)         {gpib_reset();          sendmessage(gpib_adr,"A0 X");  /* set 8 differential inputs */          sendmessage(gpib_adr,"A?");          getmessage(gpib_adr, &string[0] );/*          printf("A0 back=%s\n",string); */          sendmessage(gpib_adr,"C1,2,3,4,5,6,7,8 X"); /* 8 active channels */          sendmessage(gpib_adr,"C?");          getmessage(gpib_adr, &string[0] );/*          printf("C back=%s\n",string); */   /* set range +/- 1 volt = r0 */ /* set range +/- 2 volt = r1 */ /* set range +/- 5 volt = r2 */ /* set range +/- 10 volt = r3 */          sendmessage(gpib_adr,"R0 X");           sendmessage(gpib_adr,"R?");          getmessage(gpib_adr, &string[0] );/*          printf("R1,3 back=%s\n",string); */          sendmessage(gpib_adr,"N1 X");  /* pretrig=0 posttrig=1 */          sendmessage(gpib_adr,"N?");          getmessage(gpib_adr, &string[0] );/*          printf("N1 back=%s\n",string); */          sendmessage(gpib_adr,"G0 X");  /* compensated ascii output */          sendmessage(gpib_adr,"G?");          getmessage(gpib_adr, &string[0] );/*          printf("G0 back=%s\n",string); */            sendmessage(gpib_adr,"Q0 X");  /* cr lf eoi termination */          sendmessage(gpib_adr,"Q?");          getmessage(gpib_adr, &string[0] );/*          printf("Q0 back=%s\n",string); */          ent=1;         }          sendmessage(gpib_adr,"T6 X");  /* one shot on talk */          sendmessage(gpib_adr,"T?");          getmessage(gpib_adr, &string[0] );/*          printf("T6 back=%s\n",string); */          for(i=0;i<8;i++)            { tsleep(0x80000020);              getmessage(gpib_adr, &string[0] );/*              printf("first readback=%s\n",string);  */              sscanf(string,"%le",&volt[i]);            }          return(0);}newtime() {  getime(&timebuf);    year = (int)timebuf.t_year;    month = (int)timebuf.t_month;    day = (int)timebuf.t_day;    hour = (int)timebuf.t_hour;    min = (int)timebuf.t_minute;    sec = (int)timebuf.t_second;/*    printf("newtime  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",          year,month,day,hour,min,sec);  */ }tepoc(y,mo,d,h,min,s,days)double * days;int y,mo,d,h,min,s; { int leap,iy;   double day;/*                 0,31,28,31, 30, 31, 30, 31, 31, 30, 31, 30, 31 */   static int dmon[13] = {0,31,59,90,120,151,181,212,243,273,304,334,365};   static double ylast=0,ydays,modays,ddays,hdays,midays,sdays;    if(y != ylast)     { y = y + 1900;      if(y < 1930) y = y + 100;      ydays = 0.0;      for(iy=1900;iy<y;iy++)       { leap=0;         if(iy%4 == 0) leap=1;         if(iy%100 == 0) leap=0;         if(iy%400 == 0) leap=1;         ydays = ydays + 365.0 + (double)leap;/*         printf(" iy=%d  leap=%d  ydays=%f\n",iy,leap,ydays);  */       }      ylast = y;   }   modays = (double)dmon[mo];   ddays = (double)d - 1.0;   hdays = (double)h / 24.0;   midays = (double)min / 1440.0;   sdays = (double)s / 86400.0;   day = ydays + modays + ddays + hdays + midays + sdays;/*   printf("\n\n y=%d  mo=%d  d=%d  h=%d  min=%d  s=%d  days=%f\n",          y,mo,d,h,min,s,day);   printf("ydays=%f  modays=%f  ddays=%f\n  hdays=%f  midays=%f  sdays=%f\n",          ydays,modays,ddays,hdays,midays,sdays);   */   *days = day;  }sw(i)   /* new switch timer module */int i;{ int k,l,shift;  unsigned short *adr;  adr = (unsigned short *)( 0xf0aa000c);  k = *adr;  shift = i-1;  l = (k>>shift) & 1;  return(l);}
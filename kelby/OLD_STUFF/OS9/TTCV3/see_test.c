#include <stdio.h>#include <math.h>#include <time.h>int year,month,day,hour,min,sec;struct sgtbuf timebuf;int id,ttcadr;main(argc,argv,envs)int argc;char *argv[];char *envs[];{  FILE *fp;   int card,zone,sector,l,wait,i,ok,count,error;   unsigned short cadr,sval,dval;   double t0,tnow,dt;   char string[80];   char name[7];   int k,board;   unsigned int i1,i2,itst;   unsigned short shrt;   int trg,s1,s2,s3,s4,itr,ire,mse,tpS,tpL;   long status;   int good,bad,total,kkk;    printf("input 3in1 card serial number\n");    fscanf(stdin,"%d",&i);    sprintf(string,"card%d.log",i);    fp = fopen(string,"w");    fprintf(fp," testing 3in1 card serial number %d\n",i);    count=0;    error=0;   ttcadr = 0x1234;/*   printf("enter ttcadr\n");   fscanf(stdin,"%x",&ttcadr); */   board = 1;   id = (board<<6) | 1;    ttcvi_map(ttcadr);   reset_ctrl_can();   printf("calling can_reset - this takes a few seconds\n");   can_reset(ttcadr);/*   printf("enter ADC serial number\n");   fscanf(stdin,"%s",name);  */   printf("calling can_init\n");     can_init(board,"S10019");  /*   can_init(board,name);  */    card = 48;    newtime();    tepoc(year,month,day,hour,min,sec,&t0);    printf("start time  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",          year,month,day,hour,min,sec);      fprintf(fp,"start time  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",          year,month,day,hour,min,sec);  start:   ok=0;   status=0;   multi_low(ttcadr);   back_low(ttcadr);   set_tube(ttcadr,card);   set_intg_gain(ttcadr,5);   /* s1=s3=1 s2=s4=0 */   itr_high(ttcadr);           /* itr=1 */   intg_rd_low(ttcadr);        /* ire=0 */   mse_high(ttcadr);           /* mse=1 */   small_cap_disable(ttcadr);  /* tpS=0 */   large_cap_enable(ttcadr);   /* tpL=1 */   trig_disable(ttcadr);       /* trg=0 */   back_high(ttcadr);   back_low(ttcadr);   load_can(ttcadr);   /* fetch from 3in1 */   status=can_3in1get(id,&shrt);    /* and load can output reg */   i = (int)shrt;   trg = i & 1;   s1 = (i>>1) & 1;   s2 = (i>>2) & 1;   s3 = (i>>3) & 1;   s4 = (i>>4) & 1;   itr = (i>>5) & 1;   ire = (i>>6) & 1;   mse = (i>>7) & 1;   tpS = (i>>8) & 1;   tpL = (i>>9) & 1;   if((s1==1) && (s2==0)  && (s3==1) && (s4==0) && (itr==1) &&      (ire==0) && (mse==1) && (tpS==0) && (tpL==1) &&       (trg==0) ) ok++;       if(sw(2)==1)         { newtime();          tepoc(year,month,day,hour,min,sec,&tnow);          dt = tnow-t0;          printf("dt=%f  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",              dt,year,month,day,hour,min,sec);            printf("s1..4=1 0 1 0 itr=1 ire=0 mse=1 tpS=0 tpL=1 trg=0 sent\n");          printf("s1..4=%d %d %d %d itr=%d ire=%d mse=%d tpS=%d tpL=%d trg=%d %x\n"           ,s1,s2,s3,s4,itr,ire,mse,tpS,tpL,trg,i);        }       if(ok!=1)         { newtime();          tepoc(year,month,day,hour,min,sec,&tnow);          dt = tnow-t0;          printf("dt=%f  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",              dt,year,month,day,hour,min,sec);            printf("s1..4=1 0 1 0 itr=1 ire=0 mse=1 tpS=0 tpL=1 trg=0 sent\n");          printf("s1..4=%d %d %d %d itr=%d ire=%d mse=%d tpS=%d tpL=%d trg=%d %x\n"           ,s1,s2,s3,s4,itr,ire,mse,tpS,tpL,trg,i);          fprintf(fp,"dt=%f  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",              dt,year,month,day,hour,min,sec);            fprintf(fp,"s1..4=1 0 1 0 itr=1 ire=0 mse=1 tpS=0 tpL=1 trg=0 sent\n");          fprintf(fp,"s1..4=%d %d %d %d itr=%d ire=%d mse=%d tpS=%d tpL=%d trg=%d %x\n"           ,s1,s2,s3,s4,itr,ire,mse,tpS,tpL,trg,i);        }   set_intg_gain(ttcadr,0xa);   /* s1=s3=0 s2=s4=1 */   itr_low(ttcadr);           /* itr=0 */   intg_rd_high(ttcadr);        /* ire=1 */   mse_low(ttcadr);           /* mse=0 */   small_cap_enable(ttcadr);  /* tpS=1 */   large_cap_disable(ttcadr);   /* tpL=0 */   trig_enable(ttcadr);       /* trg=1 */   back_high(ttcadr);   back_low(ttcadr);   load_can(ttcadr);   /* fetch from 3in1 */   status=can_3in1get(id,&shrt);    /* and load can output reg */   i = (int)shrt;   trg = i & 1;   s1 = (i>>1) & 1;   s2 = (i>>2) & 1;   s3 = (i>>3) & 1;   s4 = (i>>4) & 1;   itr = (i>>5) & 1;   ire = (i>>6) & 1;   mse = (i>>7) & 1;   tpS = (i>>8) & 1;   tpL = (i>>9) & 1;   if((s1==0) && (s2==1)  && (s3==0) && (s4==1) && (itr==0) &&      (ire==1) && (mse==0) && (tpS==1) && (tpL==0) &&       (trg==1) ) ok++;       if(sw(2))         { newtime();          tepoc(year,month,day,hour,min,sec,&tnow);          dt = tnow-t0;          printf("dt=%f  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",             dt,year,month,day,hour,min,sec);            printf("s1..4=0 1 0 1 itr=0 ire=1 mse=0 tpS=1 tpL=0 trg=1 sent\n");          printf("s1..4=%d %d %d %d itr=%d ire=%d mse=%d tpS=%d tpL=%d trg=%d %x\n"           ,s1,s2,s3,s4,itr,ire,mse,tpS,tpL,trg,i);        }       if(ok!=2)         { newtime();          tepoc(year,month,day,hour,min,sec,&tnow);          dt = tnow-t0;          printf("dt=%f  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",             dt,year,month,day,hour,min,sec);            printf("s1..4=0 1 0 1 itr=0 ire=1 mse=0 tpS=1 tpL=0 trg=1 sent\n");          printf("s1..4=%d %d %d %d itr=%d ire=%d mse=%d tpS=%d tpL=%d trg=%d %x\n"           ,s1,s2,s3,s4,itr,ire,mse,tpS,tpL,trg,i);          fprintf(fp,"dt=%f  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",             dt,year,month,day,hour,min,sec);            fprintf(fp,"s1..4=0 1 0 1 itr=0 ire=1 mse=0 tpS=1 tpL=0 trg=1 sent\n");          fprintf(fp,"s1..4=%d %d %d %d itr=%d ire=%d mse=%d tpS=%d tpL=%d trg=%d %x\n"           ,s1,s2,s3,s4,itr,ire,mse,tpS,tpL,trg,i);        }  if(ok != 2) error++;  count++;  newtime();  tepoc(year,month,day,hour,min,sec,&tnow);  dt = tnow-t0;  printf("count %d   error %d   dtime %f",count,error,dt);  fflush(stdout);  printf("\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b");  if(sw(1) == 0) goto start;  newtime();  tepoc(year,month,day,hour,min,sec,&tnow);  dt = tnow-t0;  printf("ending dt=%f  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",              dt,year,month,day,hour,min,sec);    printf("ending count=%d   error=%d\n",count,error);  fprintf(fp,"end dt=%f  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",              dt,year,month,day,hour,min,sec);    fprintf(fp,"ending count=%d   error=%d\n",count,error);  i=fclose(fp); }newtime() {  getime(&timebuf);    year = (int)timebuf.t_year;    year=2001;    month = (int)timebuf.t_month;    day = (int)timebuf.t_day;    hour = (int)timebuf.t_hour;    min = (int)timebuf.t_minute;    sec = (int)timebuf.t_second;    if(sw(3)==1) printf("newtime  year=%d  month=%d  day=%d  hour=%d  min=%d  sec=%d\n",          year,month,day,hour,min,sec);   }tepoc(y,mo,d,h,min,s,seconds)double * seconds;int y,mo,d,h,min,s; { int leap,iy;   double day;/*                 0,31,28,31, 30, 31, 30, 31, 31, 30, 31, 30, 31 */   static int dmon[13] = {0,31,59,90,120,151,181,212,243,273,304,334,365};   static double ylast=0,ydays,modays,ddays,hdays,midays,sdays;    if(y != ylast)     {       ydays = 0.0;      for(iy=1900;iy<y;iy++)       { leap=0;         if(iy%4 == 0) leap=1;         if(iy%100 == 0) leap=0;         if(iy%400 == 0) leap=1;         ydays = ydays + 365.0 + (double)leap;/*         printf(" iy=%d  leap=%d  ydays=%f\n",iy,leap,ydays);  */       }      ylast = y;   }   modays = (double)dmon[mo];   ddays = (double)d - 1.0;   hdays = (double)h / 24.0;   midays = (double)min / 1440.0;   sdays = (double)s / 86400.0;   day = ydays + modays + ddays + hdays + midays + sdays;/*   printf("\n\n y=%d  mo=%d  d=%d  h=%d  min=%d  s=%d  days=%f\n",          y,mo,d,h,min,s,day);   printf("ydays=%f  modays=%f  ddays=%f\n  hdays=%f  midays=%f  sdays=%f\n",          ydays,modays,ddays,hdays,midays,sdays);   */   *seconds = day * 86400.0;  }
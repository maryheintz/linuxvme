#include <stdio.h>#include <math.h>#include "dxy.h"double sumlo[100],xsumlo[100],xxsumlo[100],meanlo[100],sigmalo[100];double sumhi[100],xsumhi[100],xxsumhi[100],meanhi[100],sigmahi[100];double xx[100],yy[100],dyy[100];double c1,c2,c3,c4,c5,aa,bb,fit,dif,sig2;int ncnt;main()  { FILE *fp,*fp_gpib;    unsigned long ext,b,c,n,a,f,q,off;    int s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11,s12,s13,s14,s15,s16;    int lam1,lam2,lam3,i,ngpib,k,l,channel,ncia,ierr,nevnt;    unsigned short data,swch,cia;    char string[80],err[80];    unsigned short lo[32],hi[32];    unsigned long qlo[32],qhi[32];    unsigned char gpib_device = 2;    char ESC=27;    double vlow,flo,fhi,sqrlo,sqrhi,vstrt,vstep,vmax;    char *label;/*  -------------------- INITIALIZE GPIB PULSER ---------------------- */    fp=fopen("cia.dat","w");    gpib_reset();    fp_gpib=fopen("gpib.dat","r");    fscanf(fp_gpib,"%lf %lf %lf %d %d %d",        &vstrt,&vstep,&vmax,&ngpib,&nevnt);/*    string[0]=getc(fp_gpib); */    printf("ngpib=%d vstrt=%f vstep=%f vmax=%f nevnt=%d\n",      ngpib,vstrt,vstep,vmax,nevnt);    for (k=0; k<ngpib; k++)     {fgetline(fp_gpib, &string[0]);        sendmessage(gpib_device, string );        sendmessage(gpib_device, "ERR?" );        getmessage(gpib_device, err );        ierr=err_parse(err);        printf("k=%d  string=%s  err=%d\n",k,string,ierr);/*        tsleep(0x80000025); */     }    printf("enter station of cia to be read\n");    fscanf(stdin,"%d",&ncia);    printf("enter channel to be plotted\n");    fscanf(stdin,"%d",&channel);    /* --------------- INITIALIZE CAMAC --------------------------------*/    b=0;    c=1;    n=7;    a=0;    /*  set up control word ext */    cdreg(&ext,&b,&c,&n,&a);    off=0;    cccz(&ext);          /* initialize */     cccc(&ext);          /* clear */    ccci(&ext,&off);     /* remove crate inhibit */    /* -------------- SET UP PLOTS --------------------------------------*/    dxyzro();    dxyset(0,0.0,vmax,5000.0,0.0,0,0);    label="Low Gain Channel  mean vs voltage";    dxylbl(0,label);    l=-1;    for (vlow=vstrt; vlow>vmax; vlow=vlow+vstep)  /* start l loop */    {l++;     sprintf(string,"A:VLOW %f",vlow);     sendmessage(gpib_device, string );     sendmessage(gpib_device, "ERR?" );     getmessage(gpib_device, err );     ierr=err_parse(err);/*     sendmessage(gpib_device, "A:VLO?" );     getmessage(gpib_device, err );     printf("vlow=%f  vback=%s\n",vlow,err); */     if(ierr != 0) printf(" error setting vlow=%f\n",vlow);/*     tsleep(0x80000025); */     sumlo[l]=0.0;     xsumlo[l]=0.0;     xxsumlo[l]=0.0;    for (k=0; k<nevnt; k++)   /* start k loop */      {/*  send pulse from camac pulse to start trigger*/       f=16;       a=7;       n=2;       data=0x1;       cdreg(&ext,&b,&c,&n,&a);       cssa(&f,&ext,&data,&q);       /*  test for lam in cia */       n=ncia;       a=0;       cdreg(&ext,&b,&c,&n,&a);       f=8;loop1:       cssa(&f,&ext,&cia,&q);       if(q == 0) goto loop1;       /*   read the cia module */       f=2;       for(i=0; i<32; i++){       cia=0;       /*  read first channel */       cssa(&f,&ext,&cia,&q);       lo[i] = (cia & 0xfff);       qlo[i]=-q;       cssa(&f,&ext,&cia,&q);       hi[i] = (cia & 0xfff);       qhi[i]=-q;       }       if(qlo[channel] == 1)         {flo=(double)lo[channel];         sumlo[l]=sumlo[l]+1.0;         xsumlo[l]=xsumlo[l]+flo;         xxsumlo[l]=xxsumlo[l]+(flo*flo);        }       /*  send pulse to cia clear input */       f=16;       a=7;       n=2;       data=0x8000;       cdreg(&ext,&b,&c,&n,&a);       cssa(&f,&ext,&data,&q);       /* clear the cia lam */       n=ncia;       a=0;       f=9;       cdreg(&ext,&b,&c,&n,&a);       cssa(&f,&ext,&cia,&q);       }  /* end k loop */       meanlo[l]=xsumlo[l]/sumlo[l];       sqrlo=(xxsumlo[l]/sumlo[l])-(meanlo[l]*meanlo[l]);       sigmalo[l]=0.0;       if(sqrlo < 0.0) printf("sigma error vlow=%f  sigma2=%f\n",vlow,sqrlo);       if(sqrlo > 0.0) sigmalo[l]=sqrt(sqrlo);       fprintf(fp,"l=%3d  vlow=%6.3f  mlo=%6.1f  siglo=%7.3f \n",        l,vlow,meanlo[l],sigmalo[l]);       dxyacc(0,vlow,meanlo[l],sigmalo[l],0);       xx[l]=vlow;       yy[l]=meanlo[l];       dyy[l]=sigmalo[l];       if(meanlo[l] < 4050.0) ncnt=l;       }  /*  end l loop *//*   printf(" starting low data fit\n"); *//* calculate the linear fit to the low data */   c1=0.0;   c2=0.0;   c3=0.0;   c4=0.0;   c5=0.0;   for(i=0;i<ncnt;i++)    { sig2=dyy[i]*dyy[i];      if(sig2<1.0) sig2=1.0;      c1=c1+(xx[i]*xx[i])/sig2;      c2=c2+(xx[i])/sig2;      c3=c3+(yy[i]*xx[i])/sig2;      c4=c4+(1.0)/sig2;      c5=c5+(yy[i])/sig2;    }    aa=(c3*c4-c2*c5)/(c1*c4-c2*c2);    bb=(c5-aa*c2)/c4;/*    printf(" low fit aa=%f   bb=%f\n",aa,bb); */    dxyset(2,0.0,-5.0,50.0,-50.0,0,0);     label="Low Gain  Residuals to straight line";     dxylbl(2,label);   for(i=0;i<ncnt;i++)    { fit=aa*xx[i]+bb;      dif=yy[i]-fit;      dxyacc(2,xx[i],dif,dyy[i],0);/*      printf(" x=%f  y=%f  fit=%f  dif=%f  dy=%f\n",        xx[i],yy[i],fit,dif,dyy[i]); */    }/* high gain loop */    fscanf(fp_gpib,"%lf %lf %lf %d %d %d",        &vstrt,&vstep,&vmax,&ngpib,&nevnt);/*    string[0]=getc(fp_gpib); */    printf("ngpib=%d vstrt=%f vstep=%f vmax=%f nevnt=%d\n",      ngpib,vstrt,vstep,vmax,nevnt);    printf("insert attenuation for high gain");    fscanf(stdin,"%s",&string[0] );    for (k=0; k<ngpib; k++)     {fgetline(fp_gpib, &string[0]);        sendmessage(gpib_device, string );        sendmessage(gpib_device, "ERR?" );        getmessage(gpib_device, err );        ierr=err_parse(err);        printf("k=%d  string=%s  err=%d\n",k,string,ierr);/*        tsleep(0x80000025); */     }    dxyset(1,0.0,vmax,5000.0,0.0,0,0);    label="High Gain Channel  mean vs voltage";    dxylbl(1,label);    l=-1;    for (vlow=vstrt; vlow>vmax; vlow=vlow+vstep)  /* start l loop */    {l++;     sprintf(string,"A:VLOW %f",vlow);     sendmessage(gpib_device, string );     sendmessage(gpib_device, "ERR?" );     getmessage(gpib_device, err );     ierr=err_parse(err);/*     sendmessage(gpib_device, "A:VLO?" );     getmessage(gpib_device, err );     printf("vlow=%f  vback=%s\n",vlow,err); */     if(ierr != 0) printf(" error setting vlow=%f\n",vlow);/*     tsleep(0x80000025); */     sumhi[l]=0.0;     xsumhi[l]=0.0;     xxsumhi[l]=0.0;    for (k=0; k<nevnt; k++)   /* start k loop */       { /*  send pulse */       f=16;       a=7;       n=2;       data=0x1;       cdreg(&ext,&b,&c,&n,&a);       cssa(&f,&ext,&data,&q);       /*  test for lam in cia */       n=ncia;       a=0;       cdreg(&ext,&b,&c,&n,&a);       f=8;loopb:       cssa(&f,&ext,&cia,&q);       if(q == 0) goto loopb;       /*   read the cia module */       f=2;       for(i=0; i<32; i++){       cia=0;       /*  read first channel */       cssa(&f,&ext,&cia,&q);       lo[i] = (cia & 0xfff);       qlo[i]=-q;       cssa(&f,&ext,&cia,&q);       hi[i] = (cia & 0xfff);       qhi[i]=-q;       }       if(qhi[channel] == 1)        {fhi=(double)hi[channel];         sumhi[l]=sumhi[l]+1.0;         xsumhi[l]=xsumhi[l]+fhi;         xxsumhi[l]=xxsumhi[l]+(fhi*fhi);        }       /*  send pulse to cia clear input */       f=16;       a=7;       n=2;       data=0x8000;       cdreg(&ext,&b,&c,&n,&a);       cssa(&f,&ext,&data,&q);       /* clear the cia lam */       n=ncia;       a=0;       f=9;       cdreg(&ext,&b,&c,&n,&a);       cssa(&f,&ext,&cia,&q);       }  /* end k loop */       meanhi[l]=xsumhi[l]/sumhi[l];       sqrhi=(xxsumhi[l]/sumhi[l])-(meanhi[l]*meanhi[l]);       sigmahi[l]=0.0;       if(sqrhi < 0.0) printf("sigma error vlow=%f  sigma2=%f\n",vlow,sqrhi);       if(sqrhi > 0.0) sigmahi[l]=sqrt(sqrhi);       fprintf(fp,"l=%3d  vlow=%6.3f  mhi=%6.1f  sighi=%7.3f\n",        l,vlow,meanhi[l],sigmahi[l]);       dxyacc(1,vlow,meanhi[l],sigmahi[l],0);       xx[l]=vlow;       yy[l]=meanhi[l];       dyy[l]=sigmahi[l];       if(meanhi[l] < 4050.0) ncnt=l;       }  /*  end l loop *//* calculate the linear fit to the high data */   c1=0.0;   c2=0.0;   c3=0.0;   c4=0.0;   c5=0.0;   for(i=0;i<ncnt;i++)    { sig2=dyy[i]*dyy[i];      if(sig2<1.0) sig2=1.0;      c1=c1+(xx[i]*xx[i])/sig2;      c2=c2+(xx[i])/sig2;      c3=c3+(yy[i]*xx[i])/sig2;      c4=c4+(1.0)/sig2;      c5=c5+(yy[i])/sig2;    }    aa=(c3*c4-c2*c5)/(c1*c4-c2*c2);    bb=(c5-aa*c2)/c4;    dxyset(3,0.0,-5.0,50.0,-50.0,0,0);     label="High Gain  Residuals to straight line";     dxylbl(3,label);   for(i=0;i<ncnt;i++)    { fit=aa*xx[i]+bb;      dif=yy[i]-fit;      dxyacc(3,xx[i],dif,dyy[i],0);    }    erasm();    dxywrt(0);    dxywrt(1);    dxywrt(2);    dxywrt(3);    i=fclose(fp);    }    double dxyfit(iplot,ifit,x)    int iplot,ifit;    double x;    { double fit;      fit=0.0;      return(fit);    }fgetline(fp,s)  FILE *fp;  char s[];  {int c,i,lim;   lim=80;   i=0;   while(--lim>0&&(c=getc(fp)) != EOF && c != '\n')    s[i++] =c;   s[i]='\0';   if(i<1)     i=EOF;   return(i);  }  int err_parse(s)      char s[];      { int i,i1,i2,k;        i1=0;        i=0;        while(s[i] != ',')        i++;        i2=i;        k=0;        for (i=i1; i<i2; i++)        { k=k*10+(int)s[i]-48;}        /*        printf("err string=%s  i1=%d i2=%d s[i1]=%c s[i2]=%c k=%d\n",          s,i1,i2,s[i1],s[i2],k); */        return(k);        }
#include <stdio.h>main()  { FILE *fp_gpib;    unsigned long ext,b,c,n,a,f,q,off,ncia;    int s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11,s12,s13,s14,s15,s16;    int lam1,lam2,lam3,i,ierr,ngpib,k,l,nevnt;    unsigned short data,swch,cia;    char string[80],err[80];    unsigned short lo[32],hi[32];    unsigned long qlo[32],qhi[32];    unsigned char gpib_device = 2;    char ESC=27;    double vlow,flo,fhi,sqrlo,sqrhi,vstrt,vstep,vmax;/*  -------------------- INITIALIZE GPIB PULSER ---------------------- */    gpib_reset();    fp_gpib=fopen("gpib2.dat","r");    fscanf(fp_gpib,"%lf %lf %lf %d %d %d",      &vstrt,&vstep,&vmax,&ngpib,&nevnt);    string[0]=getc(fp_gpib);    printf("ngpib=%d vstrt=%f vstep=%f vmax=%f nevnt=%d\n",      ngpib,vstrt,vstep,vmax,nevnt);    for (k=0; k<ngpib; k++)     {fgetline(fp_gpib, &string[0]);        sendmessage(gpib_device, string );        sendmessage(gpib_device, "ERR?" );        getmessage(gpib_device, err );        ierr=err_parse(err);        printf("k=%d  string=%s  err=%d\n",k,string,ierr);/*        tsleep(0x80000025); */     }    printf("enter station of cia to be read\n");    fscanf(stdin,"%d",&ncia);    /* --------------- INITIALIZE CAMAC --------------------------------*/    b=0;    c=1;    n=7;    a=0;    /*  set up control word ext */    cdreg(&ext,&b,&c,&n,&a);    off=0;    cccz(&ext);          /* initialize */     cccc(&ext);          /* clear */    ccci(&ext,&off);     /* remove crate inhibit */    printf("%c[?2J",ESC);   /* erase screen */loop:      for( vlow=vstrt; vlow>vmax; vlow =vlow+vstep)      { sprintf(string,"A:VLOW %f",vlow);        sendmessage(gpib_device, string );        sendmessage(gpib_device, "ERR?" );        getmessage(gpib_device, err );        ierr=err_parse(err);        if(ierr != 0) printf(" error setting vlow=%f\n",vlow);      for( k=0; k<nevnt; k++)      {       /*  read switches */       a=1;       f=0;       n=7;       cdreg(&ext,&b,&c,&n,&a);       cssa(&f,&ext,&swch,&q);       s1=swch & 0x1;       s2=(swch & 0x2)>>1;       s3=(swch & 0x4)>>2;       s4=(swch & 0x8)>>3;       s5=(swch & 0x10)>>4;       s6=(swch & 0x20)>>5;       s7=(swch & 0x40)>>6;       s8=(swch & 0x80)>>7;       s9=(swch & 0x100)>>8;       s10=(swch & 0x200)>>9;       s11=(swch & 0x400)>>10;       s12=(swch & 0x800)>>11;       s13=(swch & 0x1000)>>12;       s14=(swch & 0x2000)>>13;       s15=(swch & 0x4000)>>14;       s16=(swch & 0x8000)>>15;       /*  send pulse */       f=16;       a=7;       n=2;       data=0x1;       cdreg(&ext,&b,&c,&n,&a);       cssa(&f,&ext,&data,&q);       /*  test for lam in cia */       n=ncia;       a=0;       cdreg(&ext,&b,&c,&n,&a);       f=8;loopb:       cssa(&f,&ext,&cia,&q);       if(q == 0) goto loopb;       /*   read the cia module */       f=2;       for(i=0; i<32; i++){       cia=0;       /*  read first channel */       cssa(&f,&ext,&cia,&q);       lo[i] = (cia & 0xfff);       qlo[i]=-q;       cssa(&f,&ext,&cia,&q);       hi[i] = (cia & 0xfff);       qhi[i]=-q;       }       if(s3 == 1) {       printf("%c[2;10f CIA Station 14",ESC);     /* esc[2;10f */       printf(       "%c[4;1f   1-8 %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d ",       ESC,lo[0],qlo[0],lo[1],qlo[1],lo[2],qlo[2],lo[3],qlo[3],       lo[4],qlo[4],lo[5],qlo[5],lo[6],qlo[6],lo[7],qlo[7]);       printf(       "%c[5;1f       %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d ",       ESC,hi[0],qhi[0],hi[1],qhi[1],hi[2],qhi[2],hi[3],qhi[3],       hi[4],qhi[4],hi[5],qhi[5],hi[6],qhi[6],hi[7],qhi[7]);       printf(       "%c[6;1f  9-16 %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d ",       ESC,lo[8],qlo[8],lo[9],qlo[9],lo[10],qlo[10],lo[11],qlo[11],       lo[12],qlo[12],lo[13],qlo[13],lo[14],qlo[14],lo[15],qlo[15]);       printf(       "%c[7;1f       %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d ",       ESC,hi[8],qhi[8],hi[9],qhi[9],hi[10],qhi[10],hi[11],qhi[11],       hi[12],qhi[12],hi[13],qhi[13],hi[14],qhi[14],hi[15],qhi[15]);       printf(       "%c[8;1f 17-24 %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d ",       ESC,lo[16],qlo[16],lo[17],qlo[17],lo[18],qlo[18],lo[19],qlo[19],       lo[9],qlo[20],lo[21],qlo[21],lo[22],qlo[22],lo[23],qlo[23]);       printf(       "%c[9;1f       %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d ",       ESC,hi[16],qhi[16],hi[17],qhi[17],hi[18],qhi[18],hi[19],qhi[19],       hi[20],qhi[20],hi[21],qhi[21],hi[22],qhi[22],hi[23],qhi[23]);       printf(       "%c[10;1f 25-32 %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d ",       ESC,lo[24],qlo[24],lo[25],qlo[25],lo[26],qlo[26],lo[27],qlo[27],       lo[28],qlo[28],lo[29],qlo[29],lo[30],qlo[30],lo[31],qlo[31]);       printf(       "%c[11;1f       %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d %4d %2d ",       ESC,hi[24],qhi[24],hi[25],qhi[25],hi[26],qhi[26],hi[27],qhi[27],       hi[28],qhi[28],hi[29],qhi[29],hi[30],qhi[30],hi[31],qhi[31]);       }       f=16;       a=7;       n=2;       data=0x8000;       cdreg(&ext,&b,&c,&n,&a);       cssa(&f,&ext,&data,&q);       /*  clear cia module */       n=ncia;       a=0;       f=9;       cdreg(&ext,&b,&c,&n,&a);       cssa(&f,&ext,&cia,&q);    }}   if(f != 100) goto loop;    }fgetline(fp,s)  FILE *fp;  char s[];  {int c,i,lim;   lim=80;   i=0;   while(--lim>0&&(c=getc(fp)) != EOF && c != '\n')    s[i++] =c;   s[i]='\0';   if(i<1)     i=EOF;   return(i);  }  int err_parse(s)      char s[];      { int i,i1,i2,k;        i1=0;        i=0;        while(s[i] != ',')        i++;        i2=i;        k=0;        for (i=i1; i<i2; i++)        { k=k*10+(int)s[i]-48;}        /*        printf("err string=%s  i1=%d i2=%d s[i1]=%c s[i2]=%c k=%d\n",          s,i1,i2,s[i1],s[i2],k); */        return(k);        }
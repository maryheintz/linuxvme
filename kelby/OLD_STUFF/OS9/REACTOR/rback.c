#include <stdio.h>#include <math.h>#include <time.h>int sw1,sw2,sw3,sw4,sw5,sw6,sw7,sw8;short fdata[2][256],ipk[2],pk[2];double pd[2],dpd[2],area[2];struct{unsigned int trig;       unsigned int reset;       unsigned int status;       unsigned int sample;       unsigned int delay;       unsigned int rdall;       unsigned int rd2;       unsigned int rd1;       unsigned int rd0;}fermi;unsigned short *reg;unsigned short *reg0,*reg1,*reg2;unsigned int base=0xf0ee0000;unsigned int base2=0x80ee0000;main(argc,argv,envs)int argc;char *argv[];char *envs[];  { FILE *fp;    int k,ierr,nwds,sw1;    int kk,event,k1,k2,dt0,dt1,deldt;    double ped,dped,aval,asum,axsum,axxsum,sig2;    int max0,imax0,max1,imax1;    kk=0;    event=0;    fp=fopen("pair.data","r");    hstset(0,2000.0,0.0,100,1);    hstlbl(0,"tube 1 area");    hstset(1,2000.0,0.0,100,1);    hstlbl(1,"tube 2 area");    hstset(2,200.0,0.0,100,1);    hstlbl(2,"2nd pulse delay");    dotset(0,2000.0,0.0,2000.0,0.0,0,0);    dotlbl(0,"tube 1 area","tube 2 area");loop:       nwds=fread(&fdata[0][0],2,516,fp);       ierr = ferror(fp);       if(ierr != 0) printf("fwrite error=%d  nwds=%d\n",ierr,nwds);       event++;       kk=event/100;       if(100*kk == event) printf(" event=%d\n",event);/* =========== tube 1 ped etc ======================= */       asum = 0.0;       axsum = 0.0;       axxsum = 0.0;       for(kk=2;kk<7;kk++)        { aval = (double)fdata[0][kk];          asum = asum+1.0;          axsum = axsum + aval;          axxsum = axxsum + aval*aval;        }       ped = axsum / asum;       dped = 0.0;       sig2=axxsum/asum - ped*ped;       if(sig2>0.0) dped=sqrt(sig2);       pd[0] = ped;       dpd[0] = dped;       k1 = ipk[0]-3;       k2 = ipk[0]+3;       area[0] = 0.0;       for(k=k1;k<=k2;k++)        { area[0] = area[0]+fdata[0][k]-ped;          if(sw(2) == 1) printf(" k=%d  fdata=%d  ped=%f  area=%f\n",                 k,fdata[0][k],ped,area[0]);        }       hstacc(0,area[0],1.0);/* secondary peak? */       max0=0;       imax0=0;       for(kk=0;kk<256;kk++)        { if(kk>ipk[0]-3 && kk<ipk[0]+5) continue;          if(fdata[0][kk]>max0)             { max0= fdata[0][kk];              imax0 = kk;             }        }/* =========== tube 2 ped etc ======================= */       asum = 0.0;       axsum = 0.0;       axxsum = 0.0;       for(kk=2;kk<7;kk++)        { aval = (double)fdata[1][kk];          asum = asum+1.0;          axsum = axsum + aval;          axxsum = axxsum + aval*aval;        }       ped = axsum / asum;       dped = 0.0;       sig2=axxsum/asum - ped*ped;       if(sig2>0.0) dped=sqrt(sig2);       pd[1] = ped;       dpd[1] = dped;       k1 = ipk[1]-3;       k2 = ipk[1]+3;       area[1] = 0.0;       for(k=k1;k<=k2;k++)        { area[1] = area[1]+fdata[1][k]-ped;          if(sw(2) == 1) printf(" k=%d  fdata=%d  ped=%f  area=%f\n",                 k,fdata[1][k],ped,area[1]);        }       max1=0;       imax1 = 0;       for(kk=0;kk<256;kk++)        { if(kk>ipk[1]-3 && kk<ipk[1]+5) continue;          if(fdata[1][kk]>max1)             { max1= fdata[1][kk];              imax1 = kk;             }        }       hstacc(1,area[1],1.0);       dotacc(0,area[0],area[1]);/* ==================== display ================================= */   sw1 = sw(1);   dt0=0;   if(max0>150)     { dt0 = imax0-ipk[0];      if(dt0<0) dt0=-dt0;      if(sw(3) == 1) sw1 = 1;      printf(" ipk0=%d  imax0=%d  dt0=%d\n",          ipk[0],imax0,dt0);    }   dt1=0;   if(max1>150)    { dt1 = imax1-ipk[1];      if(dt1<0) dt1=-dt1;      if(sw(3) == 1) sw1 = 1;      printf(" ipk1=%d  imax1=%d  dt1=%d\n",          ipk[1],imax1,dt1);    }   deldt=dt0-dt1;   if(deldt<0) deldt=-deldt;   if(deldt<2 && dt0>0 && dt1>0)      { hstacc(2,(double)dt0,1.0);       printf(" plotting event deldt=%d\n",deldt);     }   if(sw1 == 1) evdisp(250);   if(sw(8) == 0 && event<10000) goto loop;   ierr = fclose(fp);   hstwrt(0);   hstwrt(1);   hstwrt(2);   dotwrt(0);}  /* end of main */evdisp(nn) int nn; { int max,mmax,idx,idy,ny,linx,ixbas,iybas,ix,iy,iylst,kx,ky,i,k,ii;   int idel,kk;   double dely,y,dy;   char str[5],string[100];   erasm();   max = pk[0];   mmax=5000;   if(max<4000) mmax=4000;   if(max<3000) mmax=3000;   if(max<2000) mmax=2000;   if(max<1000) mmax=1000;   if(max<800) mmax=800;   if(max<600) mmax=600;   if(max<500) mmax=500;   if(max<400) mmax=400;   if(max<200) mmax=200;   if(max<100) mmax=100;   if(max<50) mmax=50;   idx = 1600/nn;   linx = idx*nn;   ixbas = 100+(2200-linx)/2;   dy = 1000.0/(double)mmax;   iybas = 1900;   mova(ixbas,iybas);   drwr(linx,0);   mova(ixbas,iybas);   iylst = 0;   for(i=0;i<nn;i++)    { ii = fdata[0][i];      y = (double)ii;      y = y*dy;      iy = (int)y;      idy = iy-iylst;      drwr(0,idy);      drwr(idx,0);      iylst=iy;    }      drwr(0,-iylst);/*  label horizontal axis */    idel=10;    if(nn>100) idel=25;    if(nn>200) idel=50;    for(i=0;i<nn+1;i=i+idel)     { ix=ixbas+idx*i;       mova(ix,iybas);       drwr(0,-30);       k=i/2;       if(k*2 == i)         { sprintf(str,"%3d",i);           kx = ix-45;           if(i<100) kx = ix-55;           if(i<10) kx=ix-75;           symb(kx,iybas-100,0.0,str);         }     }/*  label vertical axis  */    ny=mmax/100;    if(ny>10) ny=10;    if(mmax == 200) ny=4;    if(mmax == 100) ny=4;    if(mmax == 50) ny=5;    y=(double)mmax*dy;    iy = (int)y;    mova(ixbas,iybas);    drwr(0,iy);    for(i=0;i<=ny;i++)     { ky = i*mmax/ny;       y = (double)ky * dy;       iy = (int)y + iybas;       mova(ixbas,iy);       drwr(-20,0);       sprintf(str,"%4d",ky);       kx = ixbas-150;       symb(kx,iy-20,0.0,str);     }   sprintf(string,     " tube1  ipk=%d   pk=%d  ped=%7.2f +/- %5.2f",       ipk[0],pk[0],pd[0],dpd[0]);   symb(500,3000,0.0,string);   max = pk[1];   mmax=5000;   if(max<4000) mmax=4000;   if(max<3000) mmax=3000;   if(max<2000) mmax=2000;   if(max<1000) mmax=1000;   if(max<800) mmax=800;   if(max<600) mmax=600;   if(max<500) mmax=500;   if(max<400) mmax=400;   if(max<200) mmax=200;   if(max<100) mmax=100;   if(max<50) mmax=50;   idx = 1600/nn;   linx = idx*nn;   ixbas = 100+(2200-linx)/2;   dy = 1200.0/(double)mmax;   iybas = 300;   mova(ixbas,iybas);   drwr(linx,0);   mova(ixbas,iybas);   iylst = 0;   for(i=0;i<nn;i++)    { ii = fdata[1][i];      y = (double)ii;      y = y*dy;      iy = (int)y;      idy = iy-iylst;      drwr(0,idy);      drwr(idx,0);      iylst=iy;    }      drwr(0,-iylst);/*  label horizontal axis */    idel=10;    if(nn>100) idel=25;    if(nn>200) idel=50;    for(i=0;i<nn+1;i=i+idel)     { ix=ixbas+idx*i;       mova(ix,iybas);       drwr(0,-30);       k=i/2;       if(k*2 == i)         { sprintf(str,"%3d",i);           kx = ix-45;           if(i<100) kx = ix-55;           if(i<10) kx=ix-75;           symb(kx,iybas-100,0.0,str);         }     }/*  label vertical axis  */    ny=mmax/100;    if(ny>10) ny=10;    if(mmax == 200) ny=4;    if(mmax == 100) ny=4;    if(mmax == 50) ny=5;    y=(double)mmax*dy;    iy = (int)y;    mova(ixbas,iybas);    drwr(0,iy);    for(i=0;i<=ny;i++)     { ky = i*mmax/ny;       y = (double)ky * dy;       iy = (int)y + iybas;       mova(ixbas,iy);       drwr(-20,0);       sprintf(str,"%4d",ky);       kx = ixbas-150;       symb(kx,iy-20,0.0,str);     }   sprintf(string,     " tube2  ipk=%d   pk=%d  ped=%7.2f +/- %5.2f",       ipk[1],pk[1],pd[1],dpd[1]);   symb(500,1600,0.0,string);    plotmx(); }sw(i)   /* new switch timer module */int i;{ int k,l,shift;  unsigned short *adr;  adr = (unsigned short *)( 0xf0aa000c);  k = *adr;  shift = i-1;  l = (k>>shift) & 1;  return(l);}double hstfit(i,l,x)int i,l;double x;{ double y;  y = 0.0;  return(y);}
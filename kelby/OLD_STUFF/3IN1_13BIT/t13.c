#include <stdio.h>#include <math.h>#include "vme.h"char string[1000];unsigned int sw_base,fermi_base,vme_base,pio_base;int ent=0;main(){    int isw[6],i1,i2,ll,i,mode,s1,s2,s3,s4,itr,ire,mse,tpS,tpL,trg,sw1,dacset;   int card,zone,sector,tube,l;   unsigned short cadr,sval,dval,tval,t1val,t2val;   double fmin,ratio,volt[6],ped[6],expr[6],volts;   int max[6],del[6],gain;   vme_base = vme_a24_base();   fermi_base = vme_base + 0xee0000;   sw_base = vme_base + 0xaa0000;   set_3in1_base(vme_base);   printf(" enter zone sector card\n");   fscanf(stdin,"%d %d %d",&zone,&sector,&card);   printf(" zone=%d sector=%d card=%d cadr=%x\n",zone,sector,card,l);   l = (zone<<12) | (sector<<6) | card;   cadr = (unsigned short)l;   card_sel(cadr);   multi_low();   tval = (unsigned short)100;   tim1_set(tval);   tval = (unsigned short)50;   tim2_set(tval);   rtime();   printf(" select desired test - loop\n");   printf("  1 = toggle intg_rd\n");   printf("  2 = toggle itr\n");   printf("  3 = mse test\n");   printf("  4 = test tp\n");   printf("  5 = toggle s1 s2 s3 or s4\n");   printf("  6 = dac set loop\n");   printf("  7 = dac set fixed value\n");   printf("  8 = step shaper cal pulses\n");   printf("  9 = read back status\n");   printf(" 10 = large cal pulses\n");   printf(" 11 = test timers\n");   printf(" 12 = cal pulses (choose dac values)\n");   printf(" 13 = test integtator gains\n");   printf(" 14 = automated integtator gains\n");   printf(" 15 = large cal pulses using multi_sel\n");   printf(" 16 = controller read/write test\n");   printf(" 17 = controller-3in1 read/write test\n");   printf(" 18 = toggle card address\n");   printf(" 19 = test status selection\n");   printf(" 20 = dac set loop intg on\n");   printf(" 21 = set dac values\n");   printf(" 22 = cal pulses small to large loop\n");   printf(" 23 = above with trig alternate\n");   printf(" 24 = controller-3in1 read/write test fixed pattern\n");   printf(" 25 = alternate set dac values\n");   printf(" 26 = toggle multi_sel with mse on for all cards\n");   printf(" 27 = toggle s1-s4,itr, and intg_rd every 2 sec\n");   printf(" 28 = toggle s1-s4,itr, and intg_rd with sw(1) value\n");   printf(" 29 = toggle RXW\n");   printf(" 30 = toggle ENABLE\n");   printf(" 31 = toggle MULTISEL\n");   printf(" 32 = toggle everything every second\n");   printf(" 33 = step dac read voltage\n");   printf(" 34 = step throuth peds dac=0 read voltage\n");   fscanf(stdin,"%d",&mode);   if(mode == 1)    {loop1:       send4_3in1(0,1);     /* set intg_rd=1 */       sleep(1);   /* wait 1 sec */       send4_3in1(0,0);     /* set intg_rd=0 */       sleep(1);   /* wait 1 sec */       if(cadr != 0xfff) goto loop1;    }   if(mode == 2)    {loop2:       send4_3in1(1,1);     /* set itr=1 */       sleep(1);   /* wait 1 sec */       send4_3in1(1,0);     /* set itr=0 */       sleep(1);   /* wait 1 sec */       if(cadr != 0xfff) goto loop2;    }   if(mode == 3)    {printf(" s1 s2 s3 s4 test using multi_sel instead of card_sel\n");       send4_3in1(3,1);     /* set mse (multi select enable */       card = 0;       l = (zone<<12) | (sector<<6) | card;       cadr = (unsigned short)l;       card_sel(cadr);       multi_high();     loop3:       send13_3in1(2,0x5);   /* set s1=s3=1 s2=s4=0 */       send13_3in1(2,0xa);   /* set s1=s3=0 s2=s4=1 */       send13_3in1(2,0xf);   /* set s1=s2=s3=s4=1   */       send13_3in1(2,0);     /* set s1=s2=s3=s4=0   */       if(cadr != 0xfff) goto loop3;    }   if(mode == 4)    {  send4_3in1(4,1);   /* enable tp pulses */       send4_3in1(5,1);   /* enable ltp pulses */       tval = (unsigned short)255;       tim1_set(tval);       tim2_set(tval);loop4:       rtime();       tp_high();       tp_low();       usleep(20);       if(cadr != 0xfff) goto loop4;    }   if(mode == 5)    {  re5:       printf("toggle which switch 1,2,3,or 4?\n");       fscanf(stdin,"%d",&ll);       if(ll<1) goto re5;       if(ll>4) goto re5;       i1=0xf;       if(ll == 1) i2=0xe;       if(ll == 2) i2=0xd;       if(ll == 3) i2=0xb;       if(ll == 4) i2=0x7;       printf(" i1=%x  i2=%x\n",i1,i2);loop5:       send13_3in1(2,i1);       sleep(1);       send13_3in1(2,i2);       sleep(1);       if(cadr != 0xfff) goto loop5;    }   if(mode == 6)     {loop6:       for(i=0;i<1024;i++)         {send13_3in1(6,i);  /* set dac value */          usleep(20);         }          sleep(1);       if(cadr != 0xfff) goto loop6;    }   if(mode == 7)    {loop7:       printf("enter dac value (hex)\n");       fscanf(stdin,"%x",&i);       send13_3in1(6,i);  /* set dac value */       if(cadr != 0xfff) goto loop7;    }   if(mode == 8)    {  send4_3in1(4,1);       send4_3in1(4,1);       printf(" enter 0 = small C  1 = large C\n");       fscanf(stdin,"%x",&ll);       printf("level set to %x\n",ll);       if(ll == 0) send4_3in1(4,1);       if(ll == 1) send4_3in1(5,1);         send13_3in1(6,0);  /* set dac value */loop8:       usleep(30);       for(i=0;i<1024;i++)        {send13_3in1(6,i);  /* set dac value */         tp_high();         usleep(20);         stime();         usleep(10);         rtime();         }       if(cadr != 0xfff) goto loop8;    }    if(mode == 9)    {loop9:       multi_low();       printf("\ns1..4=0 0 0 0 itr=0 ire=0 mse=0 tpS=0 tpL=0 trg=0 sent\n");       send4_3in1(0,0);   /* ire=0 */       send4_3in1(1,0);   /* itr=0 */       send13_3in1(2,0);  /* s1=s2=s3=s4=0 */       send4_3in1(3,0);   /* mse=0 */       send4_3in1(4,0);   /* tpS=0 */       send4_3in1(5,0);   /* tpL=0 */       send4_3in1(7,0);   /* trig=0 */       sleep(1);       read_status(&sval);   /* read back the controller shift register */       i = (int)sval;       trg = (i>>3) & 1;       s1 = (i>>4) & 1;       s2 = (i>>5) & 1;       s3 = (i>>6) & 1;       s4 = (i>>7) & 1;       itr = (i>>8) & 1;       ire = (i>>9) & 1;       mse = (i>>10) & 1;       tpS = (i>>11) & 1;       tpL = (i>>12) & 1;       printf("s1..4=%d %d %d %d itr=%d ire=%d mse=%d tpS=%d tpL=%d trg=%d %x\n"           ,s1,s2,s3,s4,itr,ire,mse,tpS,tpL,trg,i);       sleep(1);       printf("\ns1..4=1 1 1 1 itr=1 ire=1 mse=1 tpS=1 tpL=1 trg=1 sent\n");       send4_3in1(0,1);      /* ire=1 */       send4_3in1(1,1);      /* itr=1 */       send13_3in1(2,0xf);   /* s1=s2=s3=s4=1 */       send4_3in1(3,1);      /* mse=1 */       send4_3in1(4,1);      /* enable small C */       send4_3in1(5,1);      /* enable large C */       send4_3in1(7,1);      /* enable trigger output */       read_status(&sval);   /* read back the controller shift register */       i = (int)sval;       trg = (i>>3) & 1;       s1 = (i>>4) & 1;       s2 = (i>>5) & 1;       s3 = (i>>6) & 1;       s4 = (i>>7) & 1;       itr = (i>>8) & 1;       ire = (i>>9) & 1;       mse = (i>>10) & 1;       tpS = (i>>11) & 1;       tpL = (i>>12) & 1;       printf("s1..4=%d %d %d %d itr=%d ire=%d mse=%d tpS=%d tpL=%d trg=%d %x\n"           ,s1,s2,s3,s4,itr,ire,mse,tpS,tpL,trg,i);       sleep(1);       printf("\ns1..4=1 0 1 0 itr=1 ire=0 mse=1 tpS=0 tpL=1 trg=0 sent\n");       send4_3in1(0,0);   /* ire=0 */       send4_3in1(1,1);   /* itr=1 */       send13_3in1(2,0x5);   /* s1=s3=1 s2=s4=0 */       send4_3in1(3,1);   /* mse=1 */       send4_3in1(4,0);   /* tpS=0 */       send4_3in1(5,1);   /* tpL=1 */       send4_3in1(7,0);   /* trg=0 */       read_status(&sval);   /* read back the controller shift register */       i = (int)sval;       trg = (i>>3) & 1;       s1 = (i>>4) & 1;       s2 = (i>>5) & 1;       s3 = (i>>6) & 1;       s4 = (i>>7) & 1;       itr = (i>>8) & 1;       ire = (i>>9) & 1;       mse = (i>>10) & 1;       tpS = (i>>11) & 1;       tpL = (i>>12) & 1;       printf("s1..4=%d %d %d %d itr=%d ire=%d mse=%d tpS=%d tpL=%d trg=%d %x\n"           ,s1,s2,s3,s4,itr,ire,mse,tpS,tpL,trg,i);       sleep(1);       printf("\ns1..4=0 1 0 0 itr=0 ire=0 mse=0 tpS=0 tpL=0 trg=1 sent\n");       send4_3in1(0,0);   /* ire=0 */       send4_3in1(1,0);   /* itr=0 */       send13_3in1(2,2);   /* s2=1 s1=s3=s4=0 */       send4_3in1(3,0);   /* mse=0 */       send4_3in1(4,0);   /* tpS=0 */       send4_3in1(5,0);   /* tpL=0 */       send4_3in1(7,1);   /* trg=0 */       sleep(1);       read_status(&sval);   /* read back the controller shift register */       i = (int)sval;       trg = (i>>3) & 1;       s1 = (i>>4) & 1;       s2 = (i>>5) & 1;       s3 = (i>>6) & 1;       s4 = (i>>7) & 1;       itr = (i>>8) & 1;       ire = (i>>9) & 1;       mse = (i>>10) & 1;       tpS = (i>>11) & 1;       tpL = (i>>12) & 1;       printf("s1..4=%d %d %d %d itr=%d ire=%d mse=%d tpS=%d tpL=%d trg-%d %x\n"           ,s1,s2,s3,s4,itr,ire,mse,tpS,tpL,trg,i);       sleep(1);       printf("\ns1..4=0 0 0 0 itr=0 ire=1 mse=0 tpS=0 tpL=0 trg=0 sent\n");       send4_3in1(0,1);   /* ire=1 */       send4_3in1(1,0);   /* itr=0 */       send13_3in1(2,0);   /* s1=s2=s3=s4=0 */       send4_3in1(3,0);   /* mse=0 */       send4_3in1(4,0);   /* tpS=0 */       send4_3in1(5,0);   /* tpL=0 */       send4_3in1(7,0);   /* trg=0 */       sleep(1);       read_status(&sval);   /* read back the controller shift register */       i = (int)sval;       trg = (i>>3) & 1;       s1 = (i>>4) & 1;       s2 = (i>>5) & 1;       s3 = (i>>6) & 1;       s4 = (i>>7) & 1;       itr = (i>>8) & 1;       ire = (i>>9) & 1;       mse = (i>>10) & 1;       tpS = (i>>11) & 1;       tpL = (i>>12) & 1;       printf("s1..4=%d %d %d %d itr=%d ire=%d mse=%d tpS=%d tpL=%d trg=%d %x\n"           ,s1,s2,s3,s4,itr,ire,mse,tpS,tpL,trg,i);       sleep(1);       if(cadr != 0xfff) goto loop9;    }    if(mode == 10)    {t1val = (unsigned short)100;     t2val = (unsigned short)100;     tim1_set(t1val);     tim2_set(t2val);     for(i=0;i<49;i++)        { cadr = (unsigned short)( (zone<<12) | (sector<<6) | i );          card_sel(cadr);          send4_3in1(4,0);   /* disable small C */          send4_3in1(5,0);   /* disable large C */         }       cadr = (unsigned short)( (zone<<12) | (sector<<6) | card );       card_sel(cadr);       send4_3in1(4,0);   /* disable small C */       send4_3in1(5,1);   /* enable large C */       multi_low();loop10:       send13_3in1(6,0x3ff);  /* set dac value */       tp_high();       usleep(30);       stime();       usleep(10);       rtime();       sw1=sw(1);       if(sw1 == 0) goto loop10;    }   if(mode == 11)    {  send4_3in1(4,1);   /* enable tp pulses */       send4_3in1(5,0);   /* disable ltp pulses */       printf("input coarse timer value (0-255)\n");       fscanf(stdin,"%d",&mode);       t1val = (unsigned short)mode;       printf("input fine timer value (0-255)\n");       fscanf(stdin,"%d",&mode);       t2val = (unsigned short)mode;       printf(" coarse=%x fine=%x\n",(int)t1val,(int)t2val);loop11:       tim1_set(t1val);       tim2_set(t2val);       rtime();       usleep(10);       tp_high();   /* set tp high  */       stime();     /* start timers - tp goes low when timers finish*/       usleep(50);       if(cadr != 0xfff) goto loop11;    }   if(mode == 12)    {  send4_3in1(4,0);   /* enable tp pulses */       send4_3in1(5,1);   /* disable ltp pulses */       printf("input dac setting (integer)\n");       fscanf(stdin,"%d",&ll);       send13_3in1(6,ll);  /* set dac value */loop12:       usleep(30);       tp_high();       usleep(10);       stime();       usleep(10);       rtime();       sw1=sw(1);       if(sw1 == 0) goto loop12;    }    if(mode == 13)    {  expr[0]=1.0;       expr[1]=2.7;       expr[2]=3.7;       expr[3]=7.2;       expr[4]=9.7;       expr[5]=13.2;       printf(" input dac value\n");       fscanf(stdin,"%d",&ll);       send13_3in1(6,ll);  /* set dac value */       printf(" input intg_rd value 0 or 1\n");       fscanf(stdin,"%d",&ll);       send4_3in1(0,ll);       printf(" input itr value 0 or 1\n");       fscanf(stdin,"%d",&ll);       send4_3in1(1,ll);loop13:       isw[0]=1;       send13_3in1(2,1);       printf(" enter s4=0 s3=0 s2=0 s1=1 output volt[0] value\n");       fscanf(stdin,"%lf",&volt[0]);       fmin=volt[0];       isw[1]=2;       send13_3in1(2,2);       printf(" enter s4=0 s3=0 s2=1 s1=0 output volt[0] value\n");       fscanf(stdin,"%lf",&volt[1]);       if(volt[1]<fmin) fmin=volt[1];       isw[2]=0;       send13_3in1(2,0);       printf(" enter s4=0 s3=0 s2=0 s1=0 output volt[0] value\n");       fscanf(stdin,"%lf",&volt[2]);       if(volt[2]<fmin) fmin=volt[2];       isw[3]=4;       send13_3in1(2,4);       printf(" enter s4=0 s3=1 s2=0 s1=0 output volt[0] value\n");       fscanf(stdin,"%lf",&volt[3]);       if(volt[3]<fmin) fmin=volt[3];       isw[4]=8;       send13_3in1(2,8);       printf(" enter s4=1 s3=0 s2=0 s1=0 output volt[0] value\n");       fscanf(stdin,"%lf",&volt[4]);       if(volt[4]<fmin) fmin=volt[4];       isw[5]=0xc;       send13_3in1(2,0xc);       printf(" enter s4=1 s3=1 s2=0 s1=0 output volt[0] value\n");       fscanf(stdin,"%lf",&volt[5]);       if(volt[5]<fmin) fmin=volt[5];       for(i=0;i<6;i++)        { ratio=volt[i]/fmin;          printf(" i=%d  isw=%x volt=%f  ratio=%f expected ratio=%f\n",            i,isw[i],volt[i],ratio,expr[i]);}       if(cadr != 0xfff) goto loop13;    }   if(mode == 14)    {  expr[0]=1.0;       expr[1]=2.7;       expr[2]=3.7;       expr[3]=7.2;       expr[4]=9.7;       expr[5]=13.2;loop14:       printf(" input dac value\n");       fscanf(stdin,"%d",&dacset);       send4_3in1(0,1);  /* intg_rd=1 */       send4_3in1(1,1);  /* itr=1 */       isw[0]=1;       send13_3in1(2,1);       send13_3in1(6,0);  /* set dac value=0 */       sleep(2);       go_get(&ped[0]);       send13_3in1(6,dacset);  /* set dac value */       sleep(2);       go_get(&volt[0]);       printf("returned volt[0]=%f ped[0]=%f\n",volt[0],ped[0]);       fmin=volt[0]-ped[0];       isw[1]=2;       send13_3in1(2,2);       send13_3in1(6,0);  /* set dac value=0 */       sleep(2);       go_get(&ped[1]);       send13_3in1(6,dacset);  /* set dac value */       sleep(2);       go_get(&volt[1]);       printf("returned volt[1]=%f ped[1]=%f\n",volt[1],ped[1]);       if(volt[1]-ped[1]<fmin) fmin=volt[1]-ped[1];       isw[2]=0;       send13_3in1(2,0);       send13_3in1(6,0);  /* set dac value=0 */       sleep(2);       go_get(&ped[2]);       send13_3in1(6,dacset);  /* set dac value */       sleep(2);       go_get(&volt[2]);       printf("returned volt[2]=%f ped[2]=%f\n",volt[2],ped[2]);       if(volt[2]-ped[2]<fmin) fmin=volt[2]-ped[2];       isw[3]=4;       send13_3in1(2,4);       send13_3in1(6,0);  /* set dac value=0 */       sleep(2);       go_get(&ped[3]);       send13_3in1(6,dacset);  /* set dac value */       sleep(2);       go_get(&volt[3]);       printf("returned volt[3]=%f ped[3]=%f\n",volt[3],ped[3]);       if(volt[3]-ped[3]<fmin) fmin=volt[3]-ped[3];       isw[4]=8;       send13_3in1(2,8);       send13_3in1(6,0);  /* set dac value=0 */       sleep(2);       go_get(&ped[4]);       send13_3in1(6,dacset);  /* set dac value */       sleep(2);       go_get(&volt[4]);       printf("returned volt[4]=%f ped[4]=%f\n",volt[4],ped[4]);       if(volt[4]-ped[4]<fmin) fmin=volt[4]-ped[4];       isw[5]=0xc;       send13_3in1(2,0xc);       send13_3in1(6,0);  /* set dac value=0 */       sleep(2);       go_get(&ped[5]);       send13_3in1(6,dacset);  /* set dac value */       sleep(2);       go_get(&volt[5]);       printf("returned volt[5]=%f ped[5]=%f\n",volt[5],ped[5]);       if(volt[5]-ped[5]<fmin) fmin=volt[5]-ped[5];       for(i=0;i<6;i++)        { ratio=(volt[i]-ped[i])/fmin;          printf(" i=%d  isw=%x volt=%f ped=%f  ratio=%f expected ratio=%f\n",            i,isw[i],volt[i],ped[i],ratio,expr[i]);}       send4_3in1(0,1);  /* intg_rd=1 */       sleep(2);       go_get(&volt[5]);       send4_3in1(0,0);  /* intg_rd=0 */       sleep(2);       go_get(&ped[5]);       printf("intg_rd on=%f intg_rd off=%f\n",volt[5],ped[5]);       send4_3in1(0,1);  /* intg_rd=1 */       send4_3in1(1,0);  /* itr=0 */       sleep(2);       go_get(&ped[5]);       printf("itr on=%f itr off=%f\n",volt[5],ped[5]);       if(cadr != 0xfff) goto loop14;    }   if(mode == 15)    {  for(i=0;i<49;i++)       { cadr = (unsigned short)( (zone<<12) | (sector<<6) | i );         card_sel(cadr);         send4_3in1(3,1);     /* set mse (multi select enable) */        }       cadr = 0;       card_sel(cadr);       multi_high();       send4_3in1(4,1);   /* enable tp pulses */       send4_3in1(5,0);   /* disable ltp pulses */loop15:       send13_3in1(6,1023);  /* set dac value */       tp_high();       usleep(10);       stime();       usleep(10);       rtime();       sw1=sw(1);       if(sw1 == 0) goto loop15;    }   if(mode == 16)    { while(sw(1)==0)      {for(i=0;i<=0x1fff;i++)        { cadr = (unsigned short)( (zone<<12) | (sector<<6) | i );          card_sel(cadr);          sval = (unsigned short)i;          shift_set(sval);          shift_read(&dval);          if(sval != (dval&0x1fff) ) printf(" error sval=%x  dval=%x\n",                  (int)sval,(int)dval);         }      }    }   if(mode == 17)    { while(sw(1)==0)      {for(i=0;i<=0x1fff;i++)        { sval = (unsigned short)i;          wrt_shift(13,sval);          read_shift(&dval);/*          printf("sval=%x  dval=%x\n",                  (int)sval,(int)dval);  */          fflush(stdout);          if(sval != (dval&0x1fff) ) printf(" error sval=%x  dval=%x\n",                  (int)sval,(int)dval);         }      }    }   if(mode == 18)     { loop18:       cadr = (unsigned short)( (zone<<12) | (sector<<6) | card );       card_sel(cadr);       usleep(10);       cadr = (unsigned short) 0;       card_sel(cadr);       usleep(10);       if(card != 99) goto loop18;     }   if(mode == 19)      {multi_low();loop19:       for(l=0;l<49;l++)        { cadr = (unsigned short)( (zone<<12) | (sector<<6) | l );          card_sel(cadr);          send13_3in1(2,0x5);   /* s1=s3=1 s2=s4=0 */          send4_3in1(1,1);   /* itr=1 */          send4_3in1(0,0);   /* ire=0 */          send4_3in1(3,1);   /* mse=1 */          send4_3in1(4,0);   /* tpS=0 */          send4_3in1(5,1);   /* tpL=1 */          send4_3in1(7,0);   /* trg=0 */          usleep(05);          read_status(&sval);   /* read back the controller shift register */          i = (int)sval;          trg = (i>>3) & 1;          s1 = (i>>4) & 1;          s2 = (i>>5) & 1;          s3 = (i>>6) & 1;          s4 = (i>>7) & 1;          itr = (i>>8) & 1;          ire = (i>>9) & 1;          mse = (i>>10) & 1;          tpS = (i>>11) & 1;          tpL = (i>>12) & 1;          if(l == card)        sw1 = sw(1);       if(sw1 == 1)   printf("card=%d s1-4=%d %d %d %d itr=%d ire=%d mse=%d tpS=%d tpL=%d trg=%d \n",              l,s1,s2,s3,s4,itr,ire,mse,tpS,tpL,trg);          if( (s1==1) && (s2==0) && (s3==1) && (s4==0) && (ire==0)            && (itr==1) && (mse==1) && (tpS==0) && (tpL==1) && (trg==0) )             printf("card %d is there %x\n",l,i);        }       printf("end of loop\n");       sleep(1);       if(card != 99) goto loop19;      }   if(mode == 20)    {loop20:       send13_3in1(2,0xe);       send4_3in1(0,0);     /* set intg_rd=0 */       send4_3in1(1,0);     /* set itr=0 */       for(i=0;i<0x400;i++)         {send13_3in1(6,i);  /* set dac value */          usleep(05);         }         usleep(10);       if(cadr != 0xfff) goto loop20;    }   if(mode == 21)    {loop21:       printf("enter dac value\n");       fscanf(stdin,"%d",&i);       printf("dac set to %x\n",i);       send13_3in1(6,i);       goto loop21;    }   if(mode == 22)    {  send4_3in1(4,0);   /* disable small C */       send4_3in1(5,1);   /* enable large C */       send4_3in1(7,1);   /* trig=1 */loop22:    for (ll=0;ll<=0x3ff;ll=ll+0x10)    {  send13_3in1(6,ll);  /* set dac value */       usleep(30);       tp_high();       usleep(10);       stime();       usleep(10);       rtime();    }       sw1=sw(1);       if(sw1 == 0) goto loop22;    }    if(mode == 23)    {  send4_3in1(4,0);   /* disable small C */       send4_3in1(5,1);   /* enable large C */loop23:    i = 0;    for (ll=0;ll<=0x3ff;ll=ll+0x10)    {  send13_3in1(6,ll);  /* set dac value */       i++;       send4_3in1(7,(1 & i));   /* trig=? */       usleep(30);       tp_high();       usleep(10);       stime();       usleep(10);       rtime();    }       sw1=sw(1);       if(sw1 == 0) goto loop23;    }   if(mode == 24)    { printf("enter hex value\n");      fscanf(stdin,"%x",&l);      printf("%x\n",l);      while(sw(1)==0)      {for(i=0;i<=0x1fff;i++)        { sval = (unsigned short)l;          wrt_shift(13,sval);          read_shift(&dval);/*          printf("sval=%x  dval=%x\n",                  (int)sval,(int)dval);  */          fflush(stdout);          if(sval != (dval&0x1fff) ) printf(" error sval=%x  dval=%x\n",                  (int)sval,(int)dval);         }      }    }   if(mode == 25)    {loop25:       send13_3in1(6,0x3ff);       usleep(50);       send13_3in1(6,0);       usleep(50);       goto loop25;    }   if(mode == 26)    {multi_low();     for(card=1;card<49;card++)      { l = (zone<<12) | (sector<<6) | card;        cadr = (unsigned short)l;        card_sel(cadr);        send4_3in1(3,1);      }loop26:      multi_high();      sleep(1);      multi_low();      sleep(1);      goto loop26;   }   if(mode == 27)    {  printf(" toggling integrator switches 2 sec\n");       send4_3in1(4,1);      /* enable small C */       send4_3in1(5,1);      /* enable large C */loop27:       send13_3in1(0,0);       send13_3in1(1,0);       send13_3in1(2,0);       tp_low();       sleep(2);       send13_3in1(0,1);       send13_3in1(1,1);       send13_3in1(2,0xf);       tp_high();       sleep(2);       if(cadr != 0xfff) goto loop27;    }   if(mode == 28)    {  printf(" toggling integrator switches sw(1) value\n");       send4_3in1(4,1);   /* enable tp pulses */       send4_3in1(5,1);   /* enable ltp pulses */loop28:       if(sw(1) == 0)        { send13_3in1(0,0);          send13_3in1(1,0);          send13_3in1(2,0);          tp_low();/*          printf("set to 0\n"); */        }       if(sw(1) == 1)        { send13_3in1(0,1);          send13_3in1(1,1);          send13_3in1(2,0xf);          tp_high();/*          printf("set to 1\n"); */        }       if(cadr != 0xfff) goto loop28;    }   if(mode == 29)    {loop29:       rxw_high();       sleep(1);   /* wait 1 sec */       rxw_low();       sleep(1);   /* wait 1 sec */       if(cadr != 0xfff) goto loop29;    }   if(mode == 30)    {  printf(" loop toggle ENABLE\n");loop30:       ena_high();       sleep(1);   /* wait 1 sec */       ena_low();       sleep(1);   /* wait 1 sec */       if(cadr != 0xfff) goto loop30;    }   if(mode == 31)    {  printf(" loop toggle MULTISEL\n");loop31:       multi_low();       sleep(1);   /* wait 1 sec */       multi_high();       sleep(1);   /* wait 1 sec */       if(cadr != 0xfff) goto loop31;    }   if(mode == 32)    {  printf(" toggling everything every sec\n");loop32:       l = (zone<<12) | (sector<<6) | card;       cadr = (unsigned short)l;       card_sel(cadr);       send4_3in1(4,1);      /* enable small C */       send4_3in1(5,1);      /* enable large C */       send13_3in1(0,0);     /* set intg_rd=0 */           send13_3in1(1,0);     /* set itr=0 */       send13_3in1(2,0);     /* s1=s2=s3=s4=0 */       tp_low();       rxw_low();       ena_low();       multi_low();       send13_3in1(6,0);      /* set dac=0 */       back_low();/*       clk_low();  */       sleep(1);       send13_3in1(0,1);     /* set intg_rd=1 */       send13_3in1(1,1);     /* set itr=1 */       send13_3in1(2,0xf);   /* s1=s2=s3=s4=1 */       tp_high();       rxw_high();       ena_high();       multi_high();       send13_3in1(6,0x3ff);      /* set dac=0x3ff *//*       clk_high();  */               send4_3in1(4,0);      /* disable small C */       send4_3in1(5,0);      /* disable large C */       back_high();       l = (zone<<12) | (sector<<6) | 0;       cadr = (unsigned short)l;       card_sel(cadr);       sleep(1);       if(cadr != 0xfff) goto loop32;    }   if(mode == 33)    { isw[0]=0xe;      isw[1]=0xd;      isw[2]=0xf;      isw[3]=0xb;      isw[4]=0x7;      isw[5]=0x3;      max[0]=800;      max[1]=200;      max[2]=180;      max[3]=100;      max[4]=60;      max[5]=50;      del[0]=80;      del[1]=20;      del[2]=16;      del[3]=10;      del[4]=6;      del[5]=5;      send4_3in1(0,0);  /* intg_rd=0 */      send4_3in1(1,0);  /* itr=0 *//*      printf(" select isw=0,1,2,3,4,5\n");      fscanf(stdin,"%d",&gain);  */sloop33:      for(gain=0;gain<6;gain++)      { send13_3in1(2,isw[gain]);        for(i=0;i<max[gain];i=i+del[gain])                { send13_3in1(6,i);           usleep(10);loop33:           go_get(&volts);	   printf(" dac=%d  gain=%d  volts=%f\n",i,gain,volts);	   if(fpsw(0) == 1) goto loop33;         }      }       goto sloop33;    }   if(mode == 34)    { isw[0]=0xe;      isw[1]=0xd;      isw[2]=0xf;      isw[3]=0xb;      isw[4]=0x7;      isw[5]=0x3;      max[0]=800;      max[1]=200;      max[2]=180;      max[3]=100;      max[4]=60;      max[5]=50;      del[0]=80;      del[1]=20;      del[2]=16;      del[3]=10;      del[4]=6;      del[5]=5;      send4_3in1(0,0);  /* intg_rd=0 */      send4_3in1(1,0);  /* itr=0 *//*      printf(" select isw=0,1,2,3,4,5\n");      fscanf(stdin,"%d",&gain);  */sloop34:      for(gain=0;gain<6;gain++)      { send13_3in1(2,isw[gain]);        send13_3in1(6,0);        sleep(1);loop34:        go_get(&volts);	printf(" dac=0  gain=%d  volts=%f\n",gain,volts);	if(fpsw(0) == 1) goto loop34;      }       goto sloop34;    }   return(0);}fpsw(int i)  { int ent=0,l;    unsigned long *pio,kk;    if(ent==0)       { pio_base = vme_base + 0x570000;        pio = (unsigned long *)pio_base;        ent=1;}    kk = *pio;    l = (kk>>i) & 1;/*    printf(" fpsw i=%d  val=%d\n",i,l);  */    return(l);  }sw(i)int i;{ int k,l,shift;  unsigned short *adr;  (unsigned short *)adr = (unsigned short *)(sw_base + 0x0c);  k = *adr;  shift = i-1;  l = (k>>shift) & 1;  printf("k=%x  l=%x\n",k,l);  return(l);}    go_get(v)      double *v;      {double volts,factor;       unsigned short kk,*reg;       factor = 1.0;       reg = (unsigned short *) (vme_base+0xdd0018);       *reg = 0;  /* set convert to low */       reg = (unsigned short *) (vme_base+0xdd000c);       *reg = 0;  /* set convert to high */       sleep(1);       reg = (unsigned short *) (vme_base+0xdd000e);       kk = *reg;  /* read data */       volts = factor * (double)(kk & 0xfff);	*v = volts;          return(0);      }
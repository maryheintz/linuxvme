#include <stdio.h>#include <math.h>#include <time.h>#include "vme.h"unsigned int sw_base,fermi_base,vme_base,pio_base;main(argc,argv,envs)int argc;char *argv[];char *envs[];  { FILE *fp;    unsigned short i,l;    int zone,sector,card,time1,time2,time3,time4;    int dac,icap;    double capacitor,dacval;    double charge,charge_true;    char xstring[80],ystring[80],string[80],err[80];    unsigned short cadr,tc,tf;    unsigned short sval,dval;   vme_base = vme_a24_base();   fermi_base = vme_base + 0xee0000;   sw_base = vme_base + 0xaa0000;   set_3in1_base(vme_base);    int kk;    kk=0;    zone = 1;    sector = 1;    time1 = 0;    time2 = 0;    time3 = 0;    time4 = 0;    tc=200;    tf=0;    tim1_set(tc);    tim2_set(tf);    set_drawer_timer(zone,sector,1,time1);    set_drawer_timer(zone,sector,2,time2);    set_drawer_timer(zone,sector,3,time3);    set_drawer_timer(zone,sector,4,time4);    printf(" enter 1=large cap   2=small cap\n");    fscanf(stdin,"%d",&icap);    capacitor=100.0;    if(icap==2) capacitor=5.2;    printf("icap=%d   capacitor=%f\n",icap,capacitor);crg:         printf("input charge\n");         fscanf(stdin,"%lf",&charge);         dacval = (charge * 1023.0 ) / (2.0 * 4.096* capacitor);         if(dacval > 1023.0) dacval = 1023.0;         dac = (int) dacval;         charge = ( 2.0 * 4.096 * capacitor *(double)dac ) / 1023.0;         printf(" charge=%f  dacval=%f  dac=%x(hex)  cap=%f\n",           charge,dacval,dac,capacitor);    multi_low();    for(i=0;i<49;i++)       { card = i;         l = (zone<<12) | (sector<<6) | card;         cadr = (unsigned short)l;         card_sel(cadr);         sval = (unsigned short)0x555;         wrt_shift(13,sval);         read_shift(&dval);         if(sval != (dval&0x1fff) ) continue;         sval = (unsigned short)0xaaa;         wrt_shift(13,sval);         read_shift(&dval);         if(sval != (dval&0x1fff) ) continue;         printf("card %d found\n",card);         send13_3in1(2,0);   /* s1=s2=s3=s4=0 */         send4_3in1(1,0);   /* itr=0 */         send4_3in1(0,1);   /* ire=0 */         send4_3in1(3,0);   /* mse=0 */         send4_3in1(4,0);   /* small C disable */         send4_3in1(5,0);   /* large C disable */         send4_3in1(7,1);   /* trig enable */         send13_3in1(6,dac);         if(i==38 || i==40)           { if(icap==2) send4_3in1(4,1);   /* small C enable */             if(icap==1) send4_3in1(5,1);   /* large C enable */           }      }loop:        rtime();        tp_high();        setime();        if(sw(1) == 1) goto crg;         goto loop;}  /* end of main */fpsw(int i)  { int ent=0,l;    unsigned long *pio,kk;    if(ent==0)       { pio_base = vme_base + 0x570000;        pio = (unsigned long *)pio_base;        ent=1;}    kk = *pio;    l = (kk>>i) & 1;/*    printf(" fpsw i=%d  val=%d\n",i,l);  */    return(l);  }sw(i)int i;{ int k,l,shift;  unsigned short *adr;  (unsigned short *)adr = (unsigned short *)(sw_base + 0x0c);  k = *adr;  shift = i-1;  l = (k>>shift) & 1;  return(l);}